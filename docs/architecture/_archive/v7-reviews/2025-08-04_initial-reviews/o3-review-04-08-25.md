Read file: docs/architecture/current/core/database-optimization.md
Read file: docs/architecture/current/core/multi-profile.md
Read file: docs/architecture/current/core/performance.md
Read file: docs/architecture/current/core/schema.md

Read file: docs/architecture/current/core/security-compliance.md

Read file: docs/architecture/current/features/appointments.md

Read file: docs/architecture/current/features/healthcare-journey.md

Read file: docs/architecture/current/features/provider-portal.md

Read file: docs/architecture/current/features/user-experience.md

Below is an engineering review of the nine files under `docs/architecture/current/core/` and `docs/architecture/current/features/`.  
I approached this in two passes:

• Broad-lens alignment & risk assessment (architectural cohesion, long-term maintainability).  
• Micro-lens details (schema correctness, SQL compile-time errors, naming consistency, edge-case handling).

Each item is tagged with an “Impact” level so you can triage quickly.

--------------------------------------------------------------------
HIGH-LEVEL OBSERVATIONS
--------------------------------------------------------------------
1. Very strong vision: the core schema, security framework and UX plans are all consistently centred on multi-profile, patient-owned data.  
2. Scope creep risk: several feature docs (esp. User-Experience & Provider-Portal) embed v7½ / v8 ideas that will balloon implementation time if accepted unchanged.  
3. Duplication across modules: identical helper functions (`enable_bulk_relationship_mode`, `update_updated_at_column`, etc.) appear in multiple files – increases merger-conflict risk.  
4. Function / trigger proliferation: hundreds of PL/pgSQL functions will ship at once; without packaging (extensions or schema namespacing) deployment will be fragile.  
5. Operational overhead: pg_cron schedules created in many docs may collide; some use second-level cron syntax that vanilla pg_cron doesn’t accept.

--------------------------------------------------------------------
DETAILED REVIEW & SUGGESTIONS
--------------------------------------------------------------------
A. `core/schema.md`
   1. [High] `generate_updated_at` triggers exist for several tables but not for ALL new tables (e.g. `patient_imaging_reports`); add or move to a reusable trigger creation loop.  
   2. [High] `patient_clinical_events.activity_type` ENUM-by-CHECK – consider a Postgres ENUM to avoid typos and speed up comparison.  
   3. [Medium] `clinical_fact_sources` UNIQUE uses MD5 over `ST_AsText(bounding_box)` – computing this in a trigger (stored column) would be faster than every INSERT calling md5(text).  
   4. [Medium] Materialised views (`patient_medications` etc.) refresh trigger fires *per statement* on `patient_clinical_events`; high-volume inserts could cascade heavy refreshes → use incremental materialised views or deferred refresh.  
   5. [Low] `calculate_user_shard` uses `hashtext` on UUID::text – prefer `hash_uint8(uuid_send(uuid))` for uniformity.

B. `core/performance.md`
   1. [High] Many `cron.schedule('* * * * * *', …)` entries use a six-field spec; pg_cron supports only five fields unless patched. Adjust to `*/30 * * * *`.  
   2. [High] `process_cache_invalidation_queue` returns a set but caller `cron.schedule` ignores result; advisable to change return type to VOID to avoid unconsumed result warnings.  
   3. [Medium] Index maintenance function re-indexes **all** `idx_%` indexes weekly; this will lock large tables – throttle via size or age.  
   4. [Low] `monitor_bulk_operation_performance` references `detect_orphaned_relationships()` which returns SETOF but isn’t MATERIALISED; heavy call inside monitoring may hurt.

C. `core/security-compliance.md`
   1. [High] `pgp_sym_encrypt` extension call should be `CREATE EXTENSION IF NOT EXISTS pgcrypto;` (there is no separate `pgp_sym_encrypt` extension).  
   2. [High] `validate_zero_trust_access` loops across *all* `access_policies` rows each call; add composite indexes and LIMIT 1 early-exit or cache with RLS.  
   3. [Medium] Audit trigger (`enhanced_audit_trigger_function`) digests entire NEW/OLD row to SHA-256 – OK, but will explode CPU on big JSON columns; consider `row_to_json(NEW)::jsonb - 'large_blob'`.  
   4. [Low] `encryption_keys` table: primary key is UUID but also has unique `key_name`; if `key_name` drives look-ups perhaps make it PK.

D. `core/multi-profile.md`
   1. [Medium] `profile_types` & `relationship_types` TypeScript snippets are docs only; risk of diverging from SQL enums – ensure generator or single source of truth.  
   2. [Medium] `perform_soft_authentication()` etc. referenced but not defined in schema – either link to file containing definitions or stub them.

E. `core/database-optimization.md`
   – mostly narrative; no blocking issues.

F. `features/appointments.md`
   1. [High] Column naming inconsistency: table uses `patient_id` but some indexes (`idx_user_appt_patient`) reference a non-existent `user_id`. Rename index or column.  
   2. [Medium] Trigger `flag_conflict` sets `NEW.has_conflict` but table column default is NOT NULL without trigger deferrability; ensure BEFORE triggers cannot violate `NOT NULL`.  
   3. [Medium] `validate_future_appointment` prevents past dates only for `origin='user'`; manual edits (`staff`) may still violate – clarify.

G. `features/healthcare-journey.md`
   1. [High] `generate_timeline_event_from_clinical_event`: variable `searchable_content` is referenced but not declared → compile error. Declare or build inline.  
   2. [Medium] Uses `timeline_icon := 'medical-bag';` – hyphen not allowed in identifiers in many icon sets; double-check with frontend library.  
   3. [Low] Index names (`idx_timeline_events_category`) may collide with similar names in other modules – prefix with table name.

H. `features/provider-portal.md`
   – Planning document; no executable code. Ensure when tables (`provider_registry`, `patient_provider_access`) are eventually added they are namespaced to avoid clash with similarly named concepts in core schema.

I. `features/user-experience.md`
   1. [High] File is 3200+ lines; consider splitting into per-domain docs to improve maintainability.  
   2. [Medium] Multiple new large tables (`patient_health_analytics`, `notification_queue`, etc.) duplicate column definitions (`created_at`, `updated_at`) – propose a macro or Postgres `INCLUDE` pattern to DRY.  
   3. [Low] Several functions (`generate_fhir_export`, `generate_pdf_summary_export`) are stubbed; mark clearly as TODO to avoid accidental deployment.

--------------------------------------------------------------------
RECOMMENDED NEXT-STEPS PLAN
--------------------------------------------------------------------
1. Fix compile-time blockers first (missing variables, wrong cron syntax, bad index references).  
2. Introduce a **`guardian_core` Postgres schema** (or extension) and place shared helpers/triggers there; `SEARCH_PATH` keeps client SQL unchanged.  
3. Adopt naming convention: `idx_<table>_<column(s)>` to avoid cross-module index-name collisions.  
4. Gatekeeper script in CI: run `psql –f all.sql` inside a disposable database to catch syntax/compile errors early.  
5. Create a lightweight internal “RFC” process: larger future modules (provider portal, analytics) should be merged behind feature flags & separate migrations to keep v7 deliverable.  
6. Define dependency map for pg_cron jobs; centralise schedules in one migration file to avoid duplicate job names.  
7. Add integration tests for critical RLS functions (`can_access_profile_data`, `check_patient_consent`) to ensure no privilege leaks across profiles.

--------------------------------------------------------------------
FILE-LEVEL IMPACT SUMMARY
| File | Issues Found | Impact |
|------|--------------|--------|
| core/schema.md | 5 | High ↘ Medium |
| core/performance.md | 4 | High ↘ Medium |
| core/security-compliance.md | 4 | High ↘ Medium |
| core/multi-profile.md | 2 | Medium |
| core/database-optimization.md | 0 | – |
| features/appointments.md | 3 | High ↘ Medium |
| features/healthcare-journey.md | 3 | High ↘ Low |
| features/provider-portal.md | – (planning) | – |
| features/user-experience.md | 3 | High ↘ Low |

Please let me know if you’d like any of these fixes drafted into migrations or if deeper dives into specific sections are useful.