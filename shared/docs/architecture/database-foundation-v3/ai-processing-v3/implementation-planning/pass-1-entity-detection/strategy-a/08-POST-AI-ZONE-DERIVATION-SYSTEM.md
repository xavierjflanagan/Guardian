# 08 - Post-AI Zone Derivation System

**Date Created:** 2025-11-30
**Status:** Planning
**Purpose:** Define the architecture for deterministic post-AI bridge schema zone creation

---

## Executive Summary

Bridge schema zones are currently generated by the AI during Pass 1 entity detection. Production testing reveals this approach produces suboptimal results: fragmented single-line zones, duplicate overlapping zones, and inconsistent boundaries.

**The Core Insight:**
- AI is good at: "Is this line a clinical entity? What type?"
- AI is bad at: "Where do the zones start and end?"
- Deterministic code is good at: Pattern analysis on known data points

**Solution:** Move zone creation from the AI prompt to a deterministic post-processing function that analyzes entity distributions and OCR text structure.

**Key Benefits:**
1. **Deterministic** - Same input always produces same zones
2. **Debuggable** - Can inspect algorithm, adjust thresholds, trace decisions
3. **Cheaper** - Simpler prompt, smaller AI output (no zones in response)
4. **Consistent** - Handles all document types (letters, structured docs, mixed)
5. **Fixable** - When zones are wrong, we fix code, not re-prompt

---

## Problem Analysis

### Current State: AI-Generated Zones

The Pass 1 prompt currently includes zone instructions:

```
STEP 2 - GROUP INTO ZONES:
After extracting all entities, group them into bridge_schema_zones...
A zone is a contiguous Y-range on a page where entities of the same type cluster.
```

### Production Test Results (Vincent Cheers 3-Page Document)

| Metric | Value | Problem |
|--------|-------|---------|
| Total zones | 18 | Too many - fragmented |
| Single-line zones (height=1) | 10 | 56% are useless point zones |
| Duplicate Y-range zones | 2 pairs | immunisations AND conditions both at Y:580-1800 |
| Average zone height | ~200 Y-units | Many are too small for context |

### Root Causes

1. **Mechanical Zone Creation**: AI creates tight bounding boxes around entities, not semantic sections
2. **No Whitespace Awareness**: AI doesn't detect visual gaps between document sections
3. **Per-Entity-Type Zones**: AI creates separate zones for each entity type in same area
4. **No Context Expansion**: Zones don't include surrounding text needed for Pass 2

---

## Post-AI Zone Derivation Architecture

### Philosophy Shift

| Aspect | AI-Generated (Current) | Post-AI Derived (New) |
|--------|------------------------|----------------------|
| Zone definition | Cluster of Y-coordinates | Semantic document section |
| Whitespace handling | Ignored | Used as section boundary |
| Context text | Not included | Expanded to include |
| Single entity | Creates 1-line zone | Creates context-expanded zone |
| Debugging | Re-prompt and hope | Adjust thresholds, trace logic |

### System Overview

```
Pass 1 Flow (Updated):

1. AI extracts entities with Y-coordinates
   ↓
2. Parse AI response (entities only, no zones)
   ↓
3. Load OCR text lines with Y-coordinates
   ↓
4. Run Zone Derivation Algorithm
   ↓
5. Write entities + derived zones to database
```

---

## Zone Derivation Algorithm

### Inputs

1. **Entity Detections**: `{ y_coordinate, page_number, entity_type }[]`
2. **OCR Text Lines**: `{ y_coordinate, page_number, text }[]`
3. **Page Dimensions**: `{ page_number, height }[]` (for gap threshold calculation)

### Algorithm: Five-Phase Processing

#### Phase 1: Group Entities by Page and Type

```typescript
// Group entities into clusters
const clusters = groupBy(entities, e => `${e.page_number}:${e.entity_type}`);

// Result: Map<"1:medication", Entity[]>
```

#### Phase 2: Calculate Cluster Boundaries

For each cluster:
```typescript
const cluster = {
  page_number: 1,
  entity_type: 'medication',
  y_min: Math.min(...entities.map(e => e.y_coordinate)),
  y_max: Math.max(...entities.map(e => e.y_coordinate)),
  entity_count: entities.length
};
```

#### Phase 3: Merge Nearby Clusters (Same Type)

**Rule:** If two clusters of the same entity type on the same page are separated by less than `MAX_MERGE_DISTANCE`, merge them into a single zone.

```typescript
const MAX_MERGE_DISTANCE = 300; // Y-units

// If cluster A ends at Y:500 and cluster B starts at Y:700
// Gap = 200 < 300, so merge into single zone Y:500-Y:700
```

**Why:** Prevents splitting a long medication list just because of whitespace between entries.

#### Phase 4: Expand to Visual Boundaries

For each merged cluster, expand to include contextual text:

**Expansion Algorithm:**
1. Start at `y_min` of cluster
2. Scan upward through OCR text lines
3. Stop when hitting:
   - A "Significant Visual Gap" (>50 Y-units of empty space), OR
   - A "Section Header" pattern (text ending in ":"), OR
   - Page boundary
4. Repeat for downward expansion from `y_max`

```typescript
function expandToVisualBoundary(
  cluster: Cluster,
  ocrLines: OcrLine[],
  direction: 'up' | 'down'
): number {
  const GAP_THRESHOLD = 50;

  // Sort lines by Y
  const sortedLines = direction === 'up'
    ? ocrLines.filter(l => l.y < cluster.y_min).sort((a, b) => b.y - a.y)
    : ocrLines.filter(l => l.y > cluster.y_max).sort((a, b) => a.y - b.y);

  let boundary = direction === 'up' ? cluster.y_min : cluster.y_max;
  let prevY = boundary;

  for (const line of sortedLines) {
    const gap = Math.abs(line.y - prevY);

    // Stop at significant gap
    if (gap > GAP_THRESHOLD) break;

    // Stop at section header (text ending in ":")
    if (line.text.trim().endsWith(':')) {
      // Include the header in the zone
      boundary = line.y;
      break;
    }

    boundary = line.y;
    prevY = line.y;
  }

  return boundary;
}
```

#### Phase 5: Handle Isolated Entities (Context Window)

**Rule:** Single entities MUST get zones. They are clinically significant and Pass 2 needs context to process them.

For entities with no nearby same-type neighbors:
```typescript
const CONTEXT_WINDOW = 200; // Y-units above and below

if (cluster.entity_count === 1) {
  // Apply fixed context window if visual boundary expansion is too narrow
  const minHeight = CONTEXT_WINDOW * 2;
  if ((cluster.y_max - cluster.y_min) < minHeight) {
    cluster.y_min = entity.y_coordinate - CONTEXT_WINDOW;
    cluster.y_max = entity.y_coordinate + CONTEXT_WINDOW;
  }
}
```

---

## Configurable Thresholds

| Threshold | Default | Purpose |
|-----------|---------|---------|
| `MAX_MERGE_DISTANCE` | 300 Y-units | Max gap to merge same-type clusters |
| `GAP_THRESHOLD` | 50 Y-units | Significant visual gap for boundary detection |
| `CONTEXT_WINDOW` | 200 Y-units | Min context for isolated entities |
| `MIN_ZONE_HEIGHT` | 100 Y-units | Floor for zone height |

These can be adjusted based on document characteristics (average line height, page dimensions).

---

## Edge Cases and Solutions

### Case 1: Medical Letter (Continuous Text, Multiple Entity Types)

**Scenario:** A letter contains medications and conditions scattered throughout, no section headers, no significant whitespace gaps.

**OCR Example:**
```
[Y:100] Dear Dr. Smith,
[Y:130] Patient presents with Type 2 Diabetes and has been
[Y:160] taking Metformin 500mg twice daily. Blood pressure
[Y:190] controlled with Lisinopril 10mg. Hypertension stable.
[Y:220] Regards,
```

**Entities:**
- Y:130 condition (Type 2 Diabetes)
- Y:160 medication (Metformin 500mg)
- Y:190 medication (Lisinopril 10mg)
- Y:190 condition (Hypertension)

**Solution:** Create **overlapping zones** with same Y-range but different schema_types.

```json
{
  "zones": [
    { "schema_type": "conditions", "y_start": 100, "y_end": 220, "entity_count": 2 },
    { "schema_type": "medications", "y_start": 100, "y_end": 220, "entity_count": 2 }
  ]
}
```

**Why Overlapping:** Pass 2 runs specialized prompts per schema type. A "medications" prompt extracts meds; a "conditions" prompt extracts conditions. Both need the full letter context.

---

### Case 2: Structured Document (Clear Sections)

**Scenario:** Best Practice summary with clear section headers and whitespace.

**OCR Example:**
```
[Y:100] Current Medications:
[Y:130] Metformin 500mg
[Y:160] Lisinopril 10mg
[Y:190]
[Y:220]
[Y:250] Active Past History:
[Y:280] Type 2 Diabetes (2015)
[Y:310] Hypertension (2018)
[Y:340]
[Y:370] Immunisations:
[Y:400] FluQuadri 2023
[Y:430] Pfizer Comirnaty 2022
```

**Solution:** Three distinct zones respecting visual boundaries.

```json
{
  "zones": [
    { "schema_type": "medications", "y_start": 100, "y_end": 190, "entity_count": 2 },
    { "schema_type": "conditions", "y_start": 250, "y_end": 340, "entity_count": 2 },
    { "schema_type": "immunisations", "y_start": 370, "y_end": 430, "entity_count": 2 }
  ]
}
```

**Detection:** The algorithm detects:
- Gap Y:190-250 (60 units > 50 threshold) = section boundary
- Section header "Active Past History:" = zone start
- Gap Y:340-370 (30 units < 50, but header detected) = section boundary

---

### Case 3: Mixed Document (Part Structured, Part Letter)

**Scenario:** Document starts with a letter, then has structured medication list.

**Solution:** Algorithm naturally handles both patterns. Letter section gets overlapping zones; structured section gets distinct zones.

---

### Case 4: Single Isolated Entity

**Scenario:** One medication mentioned in passing within a letter.

**OCR Example:**
```
[Y:100] Patient recovering well.
[Y:130] Continue Aspirin 100mg daily.
[Y:160] Follow up in 2 weeks.
```

**Entity:** Y:130 medication (Aspirin 100mg)

**Solution:** Create context-expanded zone.

```json
{
  "zones": [
    { "schema_type": "medications", "y_start": 100, "y_end": 160, "entity_count": 1 }
  ]
}
```

**Why:** Pass 2 needs "Continue" and "daily" context to understand the medication instruction.

---

### Case 5: Multi-Page Section

**Scenario:** Medication list spans pages 3-4.

**Solution:** Create **separate zones per page**. Pass 2 handles page boundaries.

```json
{
  "zones": [
    { "schema_type": "medications", "page_number": 3, "y_start": 1800, "y_end": 2100 },
    { "schema_type": "medications", "page_number": 4, "y_start": 100, "y_end": 500 }
  ]
}
```

**Pass 2 Optimization:** These same-type zones can be batched together in one API call, with OCR text from both pages included.

---

### Case 6: Entity at Page Boundary

**Scenario:** A condition description straddles a page break.

**Solution:** Entity is assigned to the page where its primary Y-coordinate falls. Zone for that page captures available context up to page boundary.

---

## Implementation Plan

### File Location

```
apps/render-worker/src/pass1-v2/pass1-v2-zone-derivation.ts
```

### Interface

```typescript
interface ZoneDerivationInput {
  entities: Pass1Entity[];
  ocrLines: { y_coordinate: number; page_number: number; text: string }[];
  pageHeights: Map<number, number>;
}

interface DerivedZone {
  schema_type: string;
  page_number: number;
  y_start: number;
  y_end: number;
  entity_count: number;
  derivation_trace?: string; // For debugging
}

function deriveZonesFromEntities(input: ZoneDerivationInput): DerivedZone[];
```

### Integration Points

1. **Prompt Change:** Set `includeZones: false` in `buildPass1Prompt()`
2. **Parser Change:** `parsePass1Response()` returns entities only (zones array empty)
3. **New Step:** Call `deriveZonesFromEntities()` after parsing
4. **Database:** Write derived zones to `pass1_bridge_schema_zones` (same schema)

### Backward Compatibility

- Keep zone instructions available via `includeZones` flag for A/B testing
- Add `zone_derivation_method: 'ai' | 'post-ai'` to metrics for comparison

---

## Observability and Debugging

### Zone Derivation Trace Log

The algorithm should produce a trace for each zone:

```
Zone Derivation Trace:
- Page 2, medications:
  - Found 3 entities at Y: 550, 580, 620
  - Initial cluster: Y:550-620
  - Merged with nearby cluster (Y:680-710, gap=60 < 300)
  - Final cluster: Y:550-710
  - Expanded up: Y:550 -> Y:500 (hit header "Prescriptions:")
  - Expanded down: Y:710 -> Y:750 (hit visual gap >50 at Y:760)
  - Final zone: Y:500-750, entity_count: 5
```

### Metrics to Track

| Metric | Purpose |
|--------|---------|
| `zones_derived` | Total zones created |
| `merges_performed` | Clusters merged due to proximity |
| `context_expansions` | Zones expanded beyond entity bounds |
| `overlapping_zones` | Same Y-range, different types |
| `isolated_entity_zones` | Zones created for single entities |

### Comparison Dashboard

When both AI and post-AI methods are available:

```sql
SELECT
  shell_file_id,
  zone_derivation_method,
  COUNT(*) as zone_count,
  AVG(y_end - y_start) as avg_zone_height,
  SUM(CASE WHEN y_end - y_start < 10 THEN 1 ELSE 0 END) as single_line_zones
FROM pass1_bridge_schema_zones
GROUP BY shell_file_id, zone_derivation_method;
```

---

## Pass 2 Integration

### How Zones Enable Efficient Batching

1. **Group by Schema Type:** Collect all zones of same schema_type
2. **Batch API Calls:** One Pass 2 call per schema_type (not per zone)
3. **Include Relevant OCR:** For each zone, slice OCR text by Y-range
4. **Include Only Relevant Schema:** Medications prompt doesn't need conditions schema

### Token Efficiency Example

**Before (AI zones, fragmented):**
- 18 zones for 3-page document
- Potentially 18 Pass 2 calls, each with full schema set

**After (Post-AI zones, consolidated):**
- ~6 zones for same document
- 4-5 Pass 2 calls (one per schema_type present)
- Each call gets only relevant bridge schema

### Parallel Processing

Zones of different schema_types can be processed in parallel:
- `conditions` zone batch → Pass 2 worker 1
- `medications` zone batch → Pass 2 worker 2
- `immunisations` zone batch → Pass 2 worker 3

---

## Validation Plan

### Test 1: Same Document Comparison

Run AI-generated and post-AI-derived zones on Vincent Cheers 3-page document.

| Metric | AI (Current) | Post-AI (Target) |
|--------|-------------|------------------|
| Zone count | 18 | ~6-8 |
| Single-line zones | 10 | 0 |
| Duplicate Y-range zones | 2 pairs | 0 (overlapping is intentional, not duplicate) |
| Average zone height | ~200 | ~400+ |

### Test 2: Letter Document

Upload a medical letter (continuous prose) and verify:
- Overlapping zones created for different entity types
- Context includes full letter text
- No fragmentation

### Test 3: Edge Case Coverage

- Document with 1 isolated entity → zone with context window
- Document with 50-page medication list → properly merged zones
- Document with mixed structured/letter sections → appropriate handling

---

## Open Questions

1. **Section Header Detection:** Should we build a regex library for common headers ("Current Medications:", "Past History:", "Immunisations:") or rely purely on visual patterns (text ending in ":")?

2. **Minimum Entity Threshold for Zone Merging:** If a cluster has 1 entity and another has 20, should they still merge if within `MAX_MERGE_DISTANCE`? Or should we only merge similar-sized clusters?

3. **Cross-Page Merging:** Should we ever merge zones across pages (for very long sections), or always keep page boundaries as hard stops?
   *   **Decision:** Keep page boundaries as HARD STOPS. This simplifies Pass 2 processing, caching, and debugging. Pass 2 can handle multi-page sections by processing two adjacent page zones independently.

4. **Dynamic Thresholds:** Should thresholds (gap, merge distance) adapt based on document characteristics (e.g., font size inferred from average line spacing)?

---

## Appendix: Sample Output Comparison

### AI-Generated Zones (Current)

```json
{
  "bridge_schema_zones": [
    { "schema_type": "immunisations", "page_number": 2, "y_start": 580, "y_end": 1800 },
    { "schema_type": "conditions", "page_number": 2, "y_start": 580, "y_end": 1800 },
    { "schema_type": "medications", "page_number": 2, "y_start": 1660, "y_end": 1661 },
    { "schema_type": "procedures", "page_number": 1, "y_start": 2000, "y_end": 2001 }
  ]
}
```

**Problems:**
- Zones 1 & 2: Duplicate Y-range (same area, different types)
- Zones 3 & 4: Single-line (height=1), useless for context

### Post-AI Derived Zones (Target)

```json
{
  "bridge_schema_zones": [
    {
      "schema_type": "immunisations",
      "page_number": 2,
      "y_start": 550,
      "y_end": 1700,
      "entity_count": 13,
      "derivation_trace": "13 entities, expanded to section header at Y:550"
    },
    {
      "schema_type": "medications",
      "page_number": 2,
      "y_start": 1800,
      "y_end": 2100,
      "entity_count": 3,
      "derivation_trace": "3 entities, expanded to visual gap at Y:2100"
    }
  ]
}
```

**Improvements:**
- No duplicate zones (conditions extracted from immunisation records, handled by v2 prompt)
- No single-line zones
- Each zone has meaningful height for context
- Trace explains derivation logic

---

## Related Documents

- `06-AI-MODEL-SWITCHING-SYSTEM.md` - Model configuration
- `07-PASS1-PROMPT-V2-SPECIFICATION.md` - v2 prompt requirements (remove zone instructions)
- `pass1-v2-prompt.ts` - Current prompt implementation
- `pass1-v2-output-parser.ts` - Parser to be updated
- `PASS1-STRATEGY-A-MASTER.md` - Overall Pass 1 strategy

---

## Revision History

| Date | Change |
|------|--------|
| 2025-11-30 | Initial specification |






Archive:
Xavier's thoughts on pass 1 bridge schema zones - 30th November 2025:
1. I have an idea; why are we even bothering to get the AI to decide what the bridge schema zones are?
  Because if we have the clinical entities being extracted on a granular level with their Y coordinates
  then we know the entire mapping of all clinical entities and the required British game is for every
  single line of each and every single page so my thoughts are would it work if we just ditched the AI
  determine bridge scheme of zones and got a post AI function script that analyses all of the clinical
  entity outputs from past one and all of the Y coordinate lines and then also takes into account the
  remaining like coordinate lines that have text and the remaining y-coordinate lines that don't have any
  text and from that it can work out the zones. so for example if the output recognises that 15 like
  coordinate zones in a row have a medication clinical entity then a group them into a zone. The
  medication schema zone. If it detects continuous non-clinical entity like coordinate text that is
  continuous with that medication bridge chemo zone then it'll include all of that additional text
  because it might be a letter that the medications are within and the letter is important for the
  context because past two will need that context. If it notices that there is white white coordinate
  gaps or a few white coordinates lines in a row that don't have any text whether that be clinical entity
  text or non-clinical entity text then it knows and determine that there's a gap there and that is the
  border of the medication bridge schema zone - And if we made that threshold for a gap to be I don't
  know 1/5 of the size a page. I'm not sure how many white coordinates that is then it would add a bit of
  a safety guard rail. Then in the use case of a letter that contains multiple clinical entities and
  multiple Y coordinates stacked on top of each other with no gaps of significance but multiple different
  types of clinical entities it would combine the entire letter into a zone and then create X number of
  zones to match the ex number of clinical entity schema types that exist within that letter/zone. I hope
  you understand what I'm trying to get out here but I would love for you to synthesise it and add
  clarity and depth to it and to respond back to me with your thoughts whether it would work and how it
  would look taking into account all of the potential cases and the overall purpose of what a bridge
  scheme is zone is (to facilitate pass 2 both in terms of batching or is I like to call it zoning as
  well as being efficient with input tokens schema where we can kind of battle zones together that have
  the same schema type and not bloat one API call with 10 different schemers if we can help it) 
