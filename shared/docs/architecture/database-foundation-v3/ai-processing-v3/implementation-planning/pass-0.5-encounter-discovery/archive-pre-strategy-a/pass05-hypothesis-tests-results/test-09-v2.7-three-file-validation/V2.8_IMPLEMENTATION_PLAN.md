# v2.8 Implementation Plan

**Date:** 2025-11-05
**Approach:** Option 2 - Prompt changes AND page markers together
**Status:** AWAITING USER APPROVAL

---

## What We're Fixing

Based on v2.7 test failure analysis and second AI review, v2.8 will address:

1. **Boundary signal weighting dilution** - Re-add priority list
2. **Page position confusion** - Add explicit page markers in OCR text
3. **Missing Pattern D guidance** - Re-add the Frankenstein scenario example
4. **No verification step** - Add boundary verification instruction
5. **Weak justification requirement** - Require exact phrase citations

---

## Changes Summary

### Prompt Changes (~370 tokens)
1. Boundary Detection Priority List (condensed) - 100 tokens
2. Pattern D Example - 80 tokens
3. Document Header vs Metadata Distinction (condensed) - 80 tokens
4. Boundary Verification Step (NEW) - 60 tokens
5. Citation Requirement (NEW) - 40 tokens
6. Confidence <0.50 Guardrail - 10 tokens

**Total prompt impact:** v2.7: 4,060 tokens → v2.8: 4,430 tokens

### Worker Code Changes
**File:** `apps/render-worker/src/worker.ts`

**Location:** Line ~1037 (OCR text concatenation)

**Change:**
```typescript
// BEFORE (v2.7):
text: ocrResult.pages.map((p: any) =>
  p.lines.map((l: any) => l.text).join(' ')
).join('\n'),

// AFTER (v2.8):
text: ocrResult.pages.map((p: any, idx: number) =>
  `--- PAGE ${idx + 1} START ---\n` +
  p.lines.map((l: any) => l.text).join(' ') +
  `\n--- PAGE ${idx + 1} END ---`
).join('\n\n'),
```

**Token impact:** ~20 tokens per page × 20 pages = ~400 tokens per file (acceptable)

---

## Files to Create/Modify

### 1. Prompt Files

#### Create: `apps/render-worker/src/pass05/prompt-versions-and-improvements/PROMPT_v2.8_OPTIMIZED.ts`
- Full v2.8 prompt with all fixes
- Template structure (not worker-specific)

#### Create: `apps/render-worker/src/pass05/aiPrompts.v2.8.ts`
- Worker-compatible version with document info injection
- Same pattern as v2.7: `buildEncounterDiscoveryPromptV28(input: PromptInput)`

### 2. Documentation Files

#### Create: `apps/render-worker/src/pass05/prompt-versions-and-improvements/CHANGELOG_v2.7_to_v2.8.md`
Content:
```markdown
# Changelog: v2.7 → v2.8

## Date
2025-11-05

## Changes Made

### Prompt Additions (370 tokens)
1. **Boundary Detection Priority List** (100 tokens)
   - Weighted 1-9 system showing header signals override proximity
   - "Encounter Summary" = 98% confidence boundary signal

2. **Pattern D Example** (80 tokens)
   - Frankenstein file scenario: page 13 metadata vs page 14 header
   - Prevents generation date confusion

3. **Document Header vs Metadata Distinction** (80 tokens)
   - Clarifies generation date ≠ encounter date
   - "Encounter Summary" headers mark NEW encounters

4. **Boundary Verification Step** (60 tokens) - NEW
   - Final check: verify boundary signals on correct pages
   - If next page has "Encounter Summary", shift boundary forward

5. **Citation Requirement** (40 tokens) - NEW
   - Justifications must cite exact phrases from that specific page
   - Reduces off-by-one errors

6. **Confidence <0.50 Guardrail** (10 tokens)
   - Reconsider classification if confidence below 0.50

### Worker Code Changes
**File:** `apps/render-worker/src/worker.ts`
**Change:** Added explicit page markers to OCR text concatenation

**Before:**
```typescript
text: ocrResult.pages.map((p: any) =>
  p.lines.map((l: any) => l.text).join(' ')
).join('\n')
```

**After:**
```typescript
text: ocrResult.pages.map((p: any, idx: number) =>
  `--- PAGE ${idx + 1} START ---\n` +
  p.lines.map((l: any) => l.text).join(' ') +
  `\n--- PAGE ${idx + 1} END ---`
).join('\n\n')
```

**Why:** Prevents page position confusion by giving AI explicit page boundaries

## Token Impact
- Prompt: 4,060 → 4,430 tokens (+370, 9% increase)
- Per-file input: +400 tokens for page markers (acceptable)
- Total per 20-page file: ~4,830 tokens (still well within limits)

## Test Results Expected
- Frankenstein file boundary at page 13/14 (not 12/13)
- Justifications cite content from correct pages
- No off-by-one errors

## Fixes Applied
- ✅ v2.7 Frankenstein test failure (boundary one page early)
- ✅ Page position confusion (hallucinated page 13 content)
- ✅ Missing boundary priority guidance
- ✅ No verification step
```

#### Create: `apps/render-worker/src/pass05/prompt-versions-and-improvements/VALIDATION_REPORT_v2.8.md`
- Schema compliance check
- Same fields as v2.7 (no schema changes)

#### Create: `apps/render-worker/src/pass05/prompt-versions-and-improvements/INTEGRATION_GUIDE_v2.8.md`
- Updated from v2.7 guide
- Add note about page markers in worker code
- Environment variable: `PASS_05_VERSION=v2.8`

### 3. Worker Integration Files

#### Modify: `apps/render-worker/src/pass05/encounterDiscovery.ts`
**Change:** Line ~17 and ~72-74

**Add import:**
```typescript
import { buildEncounterDiscoveryPromptV28 } from './aiPrompts.v2.8';
```

**Update version selection:**
```typescript
const version = (process.env.PASS_05_VERSION || 'v2.4') as 'v2.4' | 'v2.7' | 'v2.8';

// Later in code:
promptBuilder = version === 'v2.8'
  ? buildEncounterDiscoveryPromptV28
  : version === 'v2.7'
    ? buildEncounterDiscoveryPromptV27
    : buildEncounterDiscoveryPrompt;
```

#### Modify: `apps/render-worker/src/worker.ts`
**Change:** Line ~1037 (OCR text concatenation as shown above)

### 4. Test Results Documentation

#### Update: `shared/docs/.../test-09-v2.7-three-file-validation/OCR_TEXT_ANALYSIS.md`
- Add section on v2.8 fixes implemented
- Note about page markers addressing confusion

#### Create: `shared/docs/.../test-09-v2.7-three-file-validation/V2.8_FIXES_SUMMARY.md`
- Summary of what v2.8 changes
- Link to implementation plan
- Expected test results

---

## Implementation Steps

### Step 1: Create Prompt Content
1. Create `PROMPT_v2.8_OPTIMIZED.ts` with all 6 additions
2. Create `aiPrompts.v2.8.ts` with worker integration
3. Verify token count (~4,430 tokens)

### Step 2: Create Documentation
1. Create `CHANGELOG_v2.7_to_v2.8.md`
2. Create `VALIDATION_REPORT_v2.8.md`
3. Create `INTEGRATION_GUIDE_v2.8.md`

### Step 3: Modify Worker Code
1. Update `worker.ts` - Add page markers to OCR concatenation
2. Update `encounterDiscovery.ts` - Add v2.8 support
3. Test locally with sample file (if possible)

### Step 4: Git Commit
```bash
git add apps/render-worker/src/pass05/
git add apps/render-worker/src/worker.ts
git commit -m "feat(pass05): Add v2.8 with boundary fixes and page markers

- Add boundary detection priority list
- Add Pattern D example for multi-document files
- Add boundary verification step
- Add explicit page markers in OCR text
- Require exact phrase citations in justifications
- Fix Frankenstein file boundary detection

Addresses Test 09 v2.7 failure where boundary detected at page 12/13
instead of correct 13/14 due to page position confusion."

git push
```

### Step 5: Deploy to Render.com
1. Render auto-deploys from main branch
2. Set environment variable: `PASS_05_VERSION=v2.8`
3. Monitor deployment logs

### Step 6: Re-Test
1. Upload same Frankenstein file
2. Verify boundary at page 13/14
3. Verify justifications cite correct page content
4. Test TIFF and office visit files
5. Document results

---

## Risks and Mitigation

### Risk 1: Page markers break existing functionality
**Mitigation:**
- Page markers are only in OCR text input to Pass 0.5
- Pass 1 entity detection unaffected
- Backward compatible (v2.4/v2.7 still work)

### Risk 2: Token count too high
**Mitigation:**
- Current: 4,430 prompt + 400 markers = 4,830 tokens
- GPT-5 limit: ~128k input tokens
- 20-page file full text: ~15-20k tokens
- Total input: ~25k tokens (well within limits)

### Risk 3: Page markers confuse AI
**Mitigation:**
- Simple, clear format: `--- PAGE N START/END ---`
- Explicit instruction in prompt to use these markers
- Test with real file before production

---

## Success Criteria

### Must Pass:
1. ✅ Frankenstein file boundary at page 13/14 (not 12/13)
2. ✅ Page 13 justification describes page 13 content (not page 14)
3. ✅ All page assignments reference correct page content
4. ✅ No off-by-one errors

### Should Pass:
1. ✅ TIFF lab report correctly processed
2. ✅ Office visit summary correctly processed
3. ✅ Token counts within acceptable limits
4. ✅ No deployment issues

---

## Rollback Plan

If v2.8 fails or causes issues:

1. Change environment variable: `PASS_05_VERSION=v2.7` (instant)
2. Or revert to: `PASS_05_VERSION=v2.4` (safest)
3. No code changes needed (environment variable switching)

---

## Questions for User

1. **Approve this plan?** Yes/No/Modify
2. **Any concerns about page markers?**
3. **Any additional changes needed?**
4. **Proceed with implementation?** Yes/No

---

## Next Steps After Approval

1. Execute Step 1: Create prompt files
2. Execute Step 2: Create documentation
3. Execute Step 3: Modify worker code
4. Present all changes for review before commit
5. Await approval to commit and deploy
