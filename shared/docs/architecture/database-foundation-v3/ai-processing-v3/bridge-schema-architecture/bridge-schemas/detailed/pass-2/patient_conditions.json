{
  "schema_version": "1.0.0",
  "table": "patient_conditions",
  "pass": "pass-2",
  "description": "Medical conditions and diagnoses with temporal tracking and severity management. This table stores both active and resolved conditions extracted from medical documents.",
  "clinical_context": "Use this schema for extracting medical conditions, diagnoses, and health problems from medical documents. Conditions include both acute and chronic diseases, with severity and status tracking.",

  "required_fields": [
    "patient_id",
    "event_id",
    "shell_file_id",
    "condition_name"
  ],

  "fields": {
    "patient_id": {
      "type": "uuid",
      "source": "context",
      "description": "Patient identifier from processing context (not extracted from document)",
      "required": true,
      "example": "uuid-from-context",
      "guidance": "This table HAS patient_id column (denormalized for RLS performance). The composite FK ensures patient_id consistency with parent event."
    },

    "event_id": {
      "type": "uuid",
      "source": "context",
      "description": "References parent patient_clinical_events record (the clinical event this condition is part of)",
      "required": true,
      "cascade": "ON DELETE CASCADE",
      "example": "uuid-of-parent-clinical-event",
      "guidance": "Migration 08 renamed this from clinical_event_id and made it NOT NULL. Links to parent clinical event with composite FK enforcement."
    },

    "shell_file_id": {
      "type": "uuid",
      "source": "context",
      "description": "Source document reference (NOT NULL)",
      "required": true,
      "cascade": "ON DELETE CASCADE",
      "example": "uuid-from-context",
      "guidance": "Every condition must reference its source document. This is NOT NULL in the database."
    },

    "primary_narrative_id": {
      "type": "uuid",
      "source": "context",
      "description": "Primary clinical narrative for this condition (Pass 3 feature)",
      "required": false,
      "cascade": "ON DELETE SET NULL",
      "default": null,
      "example": "uuid-of-primary-narrative",
      "guidance": "Leave null in Pass 2. Will be populated in Pass 3 when semantic narratives are created. Full narrative linking handled by narrative_event_links table."
    },

    "condition_name": {
      "type": "string",
      "description": "Name of medical condition or diagnosis",
      "required": true,
      "examples": [
        "Type 2 Diabetes Mellitus",
        "Hypertension",
        "Acute Bronchitis",
        "Coronary Artery Disease",
        "Asthma"
      ],
      "guidance": "Extract as stated in document. Can be formal diagnosis or symptom-based description."
    },

    "condition_code": {
      "type": "string",
      "description": "Medical code for condition (ICD-10, SNOMED, or custom)",
      "required": false,
      "examples": [
        "E11.9",
        "I10",
        "J20.9",
        "I25.1",
        "J45.909"
      ],
      "guidance": "Extract if explicitly stated in document. Typically assigned via medical_code_assignments table."
    },

    "condition_system": {
      "type": "enum",
      "values": ["icd10", "snomed", "custom"],
      "description": "Coding system used for condition_code",
      "required": false,
      "system_definitions": {
        "icd10": "ICD-10 diagnostic codes (most common)",
        "snomed": "SNOMED-CT codes",
        "custom": "Custom or free-text coding"
      },
      "guidance": "Database has CHECK constraint enforcing these 3 values. Only populate if condition_code is provided."
    },

    "severity": {
      "type": "enum",
      "values": ["mild", "moderate", "severe", "critical"],
      "description": "Severity level of condition",
      "required": false,
      "severity_definitions": {
        "mild": "Minor condition, minimal impact on daily activities",
        "moderate": "Noticeable symptoms, some impact on daily activities",
        "severe": "Significant symptoms, substantial impact on daily activities",
        "critical": "Life-threatening or requiring immediate intervention"
      },
      "guidance": "Database has CHECK constraint enforcing these 4 values. Extract if severity is stated or clearly implied."
    },

    "status": {
      "type": "enum",
      "values": ["active", "resolved", "inactive", "remission", "relapse"],
      "description": "Current status of condition",
      "required": false,
      "default": "active",
      "status_definitions": {
        "active": "Currently ongoing condition",
        "resolved": "Condition fully resolved",
        "inactive": "Not currently symptomatic but not fully resolved",
        "remission": "Temporary improvement of chronic condition",
        "relapse": "Return of previously resolved/remission condition"
      },
      "guidance": "Database has CHECK constraint enforcing these 5 values. Default is 'active' if not specified."
    },

    "onset_date": {
      "type": "date",
      "format": "ISO 8601 (YYYY-MM-DD)",
      "description": "Date when condition started or symptoms began",
      "required": false,
      "examples": ["2020-03-15", "2025-09-10"],
      "guidance": "PostgreSQL DATE type. Extract if onset information is stated."
    },

    "diagnosed_date": {
      "type": "date",
      "format": "ISO 8601 (YYYY-MM-DD)",
      "description": "Date when condition was formally diagnosed",
      "required": false,
      "examples": ["2020-03-20", "2025-09-12"],
      "guidance": "May be different from onset_date. Extract formal diagnosis date if stated."
    },

    "resolved_date": {
      "type": "date",
      "format": "ISO 8601 (YYYY-MM-DD)",
      "description": "Date when condition was resolved",
      "required": false,
      "examples": ["2025-09-25", "2024-12-30"],
      "guidance": "Only populate for resolved or inactive conditions. Should correspond with status='resolved'."
    },

    "diagnosed_by": {
      "type": "string",
      "description": "Name of healthcare provider who diagnosed condition",
      "required": false,
      "examples": [
        "Dr. Sarah Johnson",
        "Dr. Michael Chen",
        "Dr. Robert Martinez, Cardiologist"
      ],
      "guidance": "Extract provider name and specialty if stated."
    },

    "confidence_score": {
      "type": "numeric",
      "precision": 3,
      "scale": 2,
      "range": [0, 1],
      "description": "Overall confidence in the extraction (0.00-1.00)",
      "required": false,
      "default": 1.0,
      "examples": [1.0, 0.95, 0.80],
      "note": "Different precision than ai_confidence (2 decimals vs 3)"
    },

    "ai_extracted": {
      "type": "boolean",
      "description": "Always true for AI-extracted conditions",
      "required": true,
      "default": true
    },

    "ai_confidence": {
      "type": "numeric",
      "precision": 4,
      "scale": 3,
      "range": [0, 1],
      "description": "AI confidence in the extraction (0.000-1.000)",
      "required": true,
      "examples": [0.950, 0.875, 0.680],
      "confidence_guidance": {
        "high": ">= 0.900 - Clear, unambiguous diagnosis",
        "medium": "0.700 - 0.899 - Reasonable confidence, may need review",
        "low": "< 0.700 - Ambiguous or uncertain, requires review"
      },
      "guidance": "Be honest about uncertainty, especially for complex or critical conditions."
    },

    "requires_review": {
      "type": "boolean",
      "description": "Flag if this condition needs human review",
      "required": true,
      "default": false,
      "guidance": "Set to true if: (1) ai_confidence < 0.700, (2) severity is 'critical', (3) diagnosis is ambiguous, (4) potential life-threatening condition."
    },

    "notes": {
      "type": "string",
      "description": "Additional clinical notes about condition",
      "required": false,
      "examples": [
        "Patient reports symptoms worsening over past month",
        "Family history of cardiovascular disease",
        "Well-controlled with current medication regimen"
      ],
      "guidance": "Free-text notes providing additional context."
    },

    "clinical_context": {
      "type": "jsonb",
      "description": "Additional structured context",
      "required": false,
      "default": "{}",
      "examples": [
        {"complications": ["retinopathy", "neuropathy"], "family_history": true},
        {"triggers": ["cold weather", "exercise"], "frequency": "seasonal"}
      ],
      "guidance": "JSONB field for flexible structured data. Default is empty object."
    }
  },

  "examples": [
    {
      "description": "Active chronic condition with full details",
      "extraction": {
        "patient_id": "uuid-from-context",
        "event_id": "uuid-of-parent-clinical-event",
        "shell_file_id": "uuid-from-context",
        "condition_name": "Type 2 Diabetes Mellitus",
        "condition_code": "E11.9",
        "condition_system": "icd10",
        "severity": "moderate",
        "status": "active",
        "onset_date": "2020-03-15",
        "diagnosed_date": "2020-03-20",
        "diagnosed_by": "Dr. Sarah Johnson",
        "ai_extracted": true,
        "ai_confidence": 0.920,
        "requires_review": false
      }
    },
    {
      "description": "Resolved acute condition",
      "extraction": {
        "patient_id": "uuid-from-context",
        "event_id": "uuid-of-parent-clinical-event",
        "shell_file_id": "uuid-from-context",
        "condition_name": "Acute Bronchitis",
        "condition_code": "J20.9",
        "condition_system": "icd10",
        "severity": "mild",
        "status": "resolved",
        "onset_date": "2025-09-10",
        "diagnosed_date": "2025-09-12",
        "resolved_date": "2025-09-25",
        "diagnosed_by": "Dr. Michael Chen",
        "notes": "Viral infection, resolved with symptomatic treatment",
        "ai_extracted": true,
        "ai_confidence": 0.950,
        "requires_review": false
      }
    },
    {
      "description": "Severe condition requiring review",
      "extraction": {
        "patient_id": "uuid-from-context",
        "event_id": "uuid-of-parent-clinical-event",
        "shell_file_id": "uuid-from-context",
        "condition_name": "Coronary Artery Disease",
        "condition_code": "I25.1",
        "condition_system": "icd10",
        "severity": "severe",
        "status": "active",
        "diagnosed_date": "2025-09-28",
        "diagnosed_by": "Dr. Robert Martinez, Cardiologist",
        "notes": "Triple vessel disease identified on cardiac catheterization",
        "ai_extracted": true,
        "ai_confidence": 0.850,
        "requires_review": true
      }
    }
  ],

  "extraction_guidelines": {
    "required_fields_strict": "All 4 required fields (patient_id, event_id, shell_file_id, condition_name) must be provided. Database will reject records missing these.",
    "shell_file_mandatory": "Unlike most other tables, shell_file_id is NOT NULL for conditions. Every condition must reference its source document.",
    "status_default": "If status is not explicitly stated, default to 'active' for current conditions.",
    "severity_extraction": "Only populate severity if explicitly stated or clearly implied from clinical context.",
    "temporal_precision": "All date fields are PostgreSQL DATE type (YYYY-MM-DD), not TIMESTAMPTZ.",
    "narrative_linking": "Leave primary_narrative_id null in Pass 2. This is populated during Pass 3 semantic processing.",
    "code_assignment": "condition_code and condition_system can be extracted if stated, but typically assigned via medical_code_assignments table.",
    "critical_conditions": "For severe or critical conditions, always set requires_review=true even if ai_confidence is high.",
    "confidence_thresholds": {
      "auto_accept": ">= 0.900 for clear, unambiguous diagnoses",
      "review_recommended": "0.700 - 0.899 for moderate confidence",
      "manual_review_required": "< 0.700 or severity='critical'"
    }
  },

  "validation_rules": {
    "patient_id": "Must be valid UUID (NOT NULL)",
    "event_id": "Must reference valid patient_clinical_events record (NOT NULL)",
    "shell_file_id": "Must reference valid shell_files record (NOT NULL)",
    "condition_name": "Must be provided (NOT NULL)",
    "condition_system": "If provided, must be one of: 'icd10', 'snomed', 'custom'",
    "severity": "If provided, must be one of: 'mild', 'moderate', 'severe', 'critical'",
    "status": "Must be one of: 'active', 'resolved', 'inactive', 'remission', 'relapse' (default: 'active')",
    "ai_confidence": "Must be between 0.000 and 1.000 with 3 decimal places",
    "confidence_score": "If provided, must be between 0.00 and 1.00 with 2 decimal places",
    "clinical_context": "If provided, must be valid JSONB"
  }
}
