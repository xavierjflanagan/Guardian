{
  "schema_version": "1.0.0",
  "table": "patient_immunizations",
  "pass": "pass-2",
  "description": "Patient immunizations and vaccination records with administration details, healthcare coding standards, and adverse reaction tracking. This is safety-critical medical data for vaccination history management.",
  "clinical_context": "Use this schema for extracting immunization and vaccination records from medical documents. Immunizations are SAFETY-CRITICAL - any adverse reactions must be flagged for review. Supports multiple healthcare coding systems including SNOMED, CPT, CVX, NDC, and Australian-specific ACIR and PBS codes.",

  "required_fields": [
    "patient_id",
    "event_id",
    "vaccine_name",
    "administration_date"
  ],

  "fields": {
    "patient_id": {
      "type": "uuid",
      "source": "context",
      "description": "Patient identifier from processing context (not extracted from document)",
      "required": true,
      "example": "uuid-from-context",
      "guidance": "This table HAS patient_id column (denormalized for RLS performance). The composite FK ensures patient_id consistency with parent event."
    },

    "event_id": {
      "type": "uuid",
      "source": "context",
      "description": "References parent patient_clinical_events record (the clinical event this immunization is part of)",
      "required": true,
      "cascade": "ON DELETE CASCADE",
      "example": "uuid-of-parent-clinical-event",
      "guidance": "Migration 08 requires event_id NOT NULL. Links to parent clinical event with composite FK enforcement."
    },

    "vaccine_name": {
      "type": "string",
      "description": "Name of vaccine administered",
      "required": true,
      "examples": [
        "COVID-19 mRNA vaccine",
        "Influenza vaccine, quadrivalent",
        "Yellow Fever vaccine",
        "MMR vaccine",
        "Hepatitis B vaccine"
      ],
      "guidance": "Extract vaccine name exactly as stated in document. Can include brand name or generic description."
    },

    "administration_date": {
      "type": "timestamptz",
      "format": "ISO 8601 with timezone (YYYY-MM-DDTHH:MM:SSZ)",
      "description": "Date and time when vaccine was administered",
      "required": true,
      "examples": ["2025-09-30T10:30:00Z", "2025-04-15T14:00:00Z"],
      "guidance": "PostgreSQL TIMESTAMPTZ type. Extract date and time if available, otherwise use date with default time."
    },

    "vaccine_type": {
      "type": "string",
      "description": "Type or category of vaccine",
      "required": false,
      "examples": [
        "mRNA",
        "inactivated",
        "live attenuated",
        "subunit",
        "recombinant",
        "conjugate"
      ],
      "vaccine_type_guidance": {
        "mRNA": "mRNA vaccines (e.g., COVID-19 Pfizer, Moderna)",
        "inactivated": "Inactivated virus vaccines (e.g., flu shots, polio)",
        "live attenuated": "Live but weakened virus vaccines (e.g., MMR, varicella)",
        "subunit": "Subunit, recombinant, or conjugate vaccines (e.g., HPV, hepatitis B)"
      },
      "guidance": "Extract if vaccine type is explicitly stated or can be inferred from vaccine name."
    },

    "manufacturer": {
      "type": "string",
      "description": "Vaccine manufacturer",
      "required": false,
      "examples": [
        "Pfizer-BioNTech",
        "Moderna",
        "Johnson & Johnson",
        "Seqirus",
        "Sanofi Pasteur",
        "GlaxoSmithKline"
      ],
      "guidance": "Extract manufacturer name if stated in document."
    },

    "lot_number": {
      "type": "string",
      "description": "Vaccine lot or batch number",
      "required": false,
      "examples": ["EW0182", "YF12345", "FL9087"],
      "guidance": "Extract lot number if documented. Important for vaccine traceability and adverse event reporting."
    },

    "expiration_date": {
      "type": "date",
      "format": "ISO 8601 (YYYY-MM-DD)",
      "description": "Vaccine expiration date",
      "required": false,
      "examples": ["2026-03-31", "2025-12-31"],
      "guidance": "PostgreSQL DATE type (no time component). Extract if expiration date is documented."
    },

    "dose_number": {
      "type": "integer",
      "description": "Dose number in vaccination series (1st dose, 2nd dose, booster, etc.)",
      "required": false,
      "examples": [1, 2, 3],
      "guidance": "Extract numeric dose number if documented (e.g., '1st dose' → 1, '2nd dose' → 2, 'booster' → can be numbered sequentially)."
    },

    "dose_amount": {
      "type": "numeric",
      "precision": 6,
      "scale": 3,
      "description": "Amount of vaccine administered in mL",
      "required": false,
      "examples": [0.3, 0.5, 1.0, 1.5],
      "guidance": "NUMERIC(6,3) - 6 total digits with 3 decimal places. Extract dose amount if documented (e.g., '0.5 mL' → 0.5)."
    },

    "route_of_administration": {
      "type": "string",
      "description": "Route by which vaccine was administered",
      "required": false,
      "examples": [
        "intramuscular",
        "intranasal",
        "oral",
        "subcutaneous",
        "intradermal"
      ],
      "guidance": "Extract route of administration if documented. Intramuscular is most common for vaccines."
    },

    "anatomical_site": {
      "type": "string",
      "description": "Anatomical site where vaccine was administered",
      "required": false,
      "examples": [
        "left deltoid",
        "right deltoid",
        "anterolateral thigh",
        "left upper arm",
        "right upper arm"
      ],
      "guidance": "Extract specific anatomical location if documented."
    },

    "snomed_code": {
      "type": "string",
      "description": "SNOMED-CT vaccine code",
      "required": false,
      "examples": ["840534001", "398730003", "871765008"],
      "guidance": "Extract SNOMED-CT code if stated. Typically assigned via medical_code_assignments table."
    },

    "cpt_code": {
      "type": "string",
      "description": "CPT administration code",
      "required": false,
      "examples": ["91300", "90686", "90688", "90471"],
      "guidance": "Current Procedural Terminology codes for vaccine administration. Extract if stated."
    },

    "cvx_code": {
      "type": "string",
      "description": "CDC vaccine code (CVX)",
      "required": false,
      "examples": ["208", "150", "37", "03"],
      "guidance": "CDC CVX codes are standard in US for vaccine identification. Extract if documented."
    },

    "ndc_code": {
      "type": "string",
      "description": "National Drug Code for vaccine product",
      "required": false,
      "examples": ["59267-1000-1", "49281-0400-10"],
      "guidance": "NDC codes identify specific vaccine products. Extract if documented."
    },

    "acir_code": {
      "type": "string",
      "description": "Australian Childhood Immunisation Register code",
      "required": false,
      "examples": ["ACIR123", "ACIR456"],
      "guidance": "Australian-specific immunisation register codes. Extract if present in Australian medical documents."
    },

    "pbs_item_code": {
      "type": "string",
      "description": "PBS item code for funded vaccines (Australian)",
      "required": false,
      "examples": ["8254K", "2179B"],
      "guidance": "Australian Pharmaceutical Benefits Scheme codes for government-funded vaccines. Extract if documented."
    },

    "indication": {
      "type": "string",
      "description": "Reason for vaccination",
      "required": false,
      "examples": [
        "routine immunization",
        "travel to endemic region",
        "occupational exposure",
        "outbreak response",
        "catch-up vaccination"
      ],
      "guidance": "Extract clinical indication or reason for vaccination if stated."
    },

    "contraindications": {
      "type": "array",
      "item_type": "string",
      "description": "Array of contraindications noted before or during vaccination",
      "required": false,
      "examples": [
        ["severe allergic reaction to previous dose"],
        ["immunocompromised status", "pregnancy"],
        []
      ],
      "guidance": "PostgreSQL TEXT[] array. Extract any documented contraindications as separate array elements."
    },

    "adverse_reactions": {
      "type": "array",
      "item_type": "string",
      "description": "Array of adverse reactions experienced after vaccination",
      "required": false,
      "examples": [
        ["mild fever", "injection site soreness"],
        ["fatigue", "headache"],
        []
      ],
      "guidance": "PostgreSQL TEXT[] array. Extract any documented adverse reactions. If adverse reactions present, ALWAYS set requires_review=true."
    },

    "administered_by": {
      "type": "string",
      "description": "Name of healthcare provider who administered the vaccine",
      "required": false,
      "examples": [
        "Nurse Sarah Williams, RN",
        "Dr. Michael Chen",
        "Travel Clinic Nurse"
      ],
      "guidance": "Extract provider name and credentials if documented."
    },

    "administering_facility": {
      "type": "string",
      "description": "Name of facility where vaccine was administered",
      "required": false,
      "examples": [
        "City Health Clinic",
        "International Travel Health Center",
        "Community Pharmacy"
      ],
      "guidance": "Extract facility name if documented."
    },

    "coding_confidence": {
      "type": "numeric",
      "precision": 4,
      "scale": 3,
      "range": [0, 1],
      "description": "Confidence in medical coding assignment (0.000-1.000)",
      "required": false,
      "examples": [0.950, 0.875, 0.680],
      "guidance": "Separate confidence score for medical code assignments (SNOMED, CVX, etc.). Use if codes were AI-assigned."
    },

    "source_shell_file_id": {
      "type": "uuid",
      "source": "context",
      "description": "Source document reference",
      "required": false,
      "example": "uuid-from-context",
      "guidance": "UUID of the shell file this immunization was extracted from. Optional FK."
    },

    "ai_extracted": {
      "type": "boolean",
      "description": "Always true for AI-extracted immunizations",
      "required": true,
      "default": true
    },

    "ai_confidence": {
      "type": "numeric",
      "precision": 4,
      "scale": 3,
      "range": [0, 1],
      "description": "AI confidence in the extraction (0.000-1.000)",
      "required": true,
      "examples": [0.950, 0.920, 0.880],
      "confidence_guidance": {
        "high": ">= 0.900 - Clear, unambiguous vaccination record",
        "medium": "0.700 - 0.899 - Reasonable confidence, may need review",
        "low": "< 0.700 - Ambiguous or uncertain, requires review"
      },
      "guidance": "Immunizations are safety-critical. Be conservative with confidence scores, especially if adverse reactions are mentioned."
    },

    "requires_review": {
      "type": "boolean",
      "description": "Flag if this immunization needs human review",
      "required": true,
      "default": false,
      "guidance": "ALWAYS set to true if: (1) adverse_reactions array is not empty, (2) ai_confidence < 0.900, (3) contraindications noted, (4) any safety concerns."
    },

    "clinical_validation_status": {
      "type": "enum",
      "values": ["pending", "validated", "requires_review", "rejected"],
      "description": "Clinical validation workflow status",
      "required": false,
      "default": "pending",
      "status_definitions": {
        "pending": "Awaiting clinical validation (default for all AI extractions)",
        "validated": "Clinically validated and confirmed by healthcare provider",
        "requires_review": "Flagged for mandatory human review due to data quality or safety",
        "rejected": "Rejected during validation process, not a valid immunization record"
      },
      "guidance": "Database has CHECK constraint enforcing these 4 values. Default is 'pending' for all AI-extracted records."
    }
  },

  "examples": [
    {
      "description": "COVID-19 vaccination with full details and multiple coding systems",
      "extraction": {
        "patient_id": "uuid-from-context",
        "event_id": "uuid-of-parent-clinical-event",
        "vaccine_name": "COVID-19 mRNA vaccine",
        "vaccine_type": "mRNA",
        "manufacturer": "Pfizer-BioNTech",
        "lot_number": "EW0182",
        "expiration_date": "2026-03-31",
        "dose_number": 2,
        "dose_amount": 0.3,
        "route_of_administration": "intramuscular",
        "anatomical_site": "left deltoid",
        "cvx_code": "208",
        "cpt_code": "91300",
        "indication": "routine immunization",
        "administered_by": "Nurse Sarah Williams, RN",
        "administering_facility": "City Health Clinic",
        "administration_date": "2025-09-30T10:30:00Z",
        "source_shell_file_id": "uuid-from-context",
        "ai_extracted": true,
        "ai_confidence": 0.950,
        "requires_review": false,
        "clinical_validation_status": "pending"
      }
    },
    {
      "description": "Influenza vaccination with basic details",
      "extraction": {
        "patient_id": "uuid-from-context",
        "event_id": "uuid-of-parent-clinical-event",
        "vaccine_name": "Influenza vaccine, quadrivalent",
        "vaccine_type": "inactivated",
        "manufacturer": "Seqirus",
        "dose_number": 1,
        "route_of_administration": "intramuscular",
        "anatomical_site": "right deltoid",
        "cvx_code": "150",
        "indication": "routine immunization",
        "administered_by": "Dr. Michael Chen",
        "administration_date": "2025-04-15T14:00:00Z",
        "ai_extracted": true,
        "ai_confidence": 0.920,
        "requires_review": false,
        "clinical_validation_status": "pending"
      }
    },
    {
      "description": "Travel vaccination with adverse reactions requiring review",
      "extraction": {
        "patient_id": "uuid-from-context",
        "event_id": "uuid-of-parent-clinical-event",
        "vaccine_name": "Yellow Fever vaccine",
        "vaccine_type": "live attenuated",
        "manufacturer": "Sanofi Pasteur",
        "lot_number": "YF12345",
        "dose_number": 1,
        "dose_amount": 0.5,
        "route_of_administration": "subcutaneous",
        "anatomical_site": "left upper arm",
        "cvx_code": "37",
        "indication": "travel to endemic region",
        "adverse_reactions": ["mild fever", "injection site soreness"],
        "administered_by": "Travel Clinic Nurse",
        "administering_facility": "International Travel Health Center",
        "administration_date": "2025-08-10T09:00:00Z",
        "ai_extracted": true,
        "ai_confidence": 0.880,
        "requires_review": true,
        "clinical_validation_status": "requires_review"
      }
    }
  ],

  "extraction_guidelines": {
    "safety_critical": "Immunizations are SAFETY-CRITICAL. ALWAYS set requires_review=true if adverse_reactions is not empty, regardless of ai_confidence.",
    "adverse_reactions_threshold": "ANY documented adverse reaction requires requires_review=true AND clinical_validation_status='requires_review'.",
    "required_fields_strict": "All 4 required fields (patient_id, event_id, vaccine_name, administration_date) must be provided. Database will reject records missing these.",
    "administration_date_format": "Use TIMESTAMPTZ format (ISO 8601 with timezone). If only date is available, append 'T00:00:00Z'.",
    "dose_amount_precision": "dose_amount uses NUMERIC(6,3) - maximum 6 total digits with 3 decimal places (e.g., 0.300, 1.500).",
    "text_arrays": "contraindications and adverse_reactions are PostgreSQL TEXT[] arrays. Use empty array [] if none documented, or omit field entirely.",
    "healthcare_codes_optional": "All coding fields (SNOMED, CPT, CVX, NDC, ACIR, PBS) are optional. Extract if stated, but typically assigned via medical_code_assignments table.",
    "australian_specifics": "acir_code and pbs_item_code are specific to Australian healthcare system. Only extract from Australian medical documents.",
    "validation_status_default": "Always use clinical_validation_status='pending' for initial AI extractions. Human reviewers update this field.",
    "confidence_thresholds": {
      "auto_accept": ">= 0.900 AND no adverse_reactions AND no contraindications",
      "review_recommended": "0.700 - 0.899 OR adverse_reactions present",
      "manual_review_required": "< 0.700 OR adverse_reactions present OR contraindications noted"
    }
  },

  "validation_rules": {
    "patient_id": "Must be valid UUID (NOT NULL)",
    "event_id": "Must reference valid patient_clinical_events record (NOT NULL)",
    "vaccine_name": "Must be provided (NOT NULL)",
    "administration_date": "Must be valid ISO 8601 TIMESTAMPTZ format (NOT NULL)",
    "dose_amount": "If provided, must be NUMERIC(6,3) - max 6 digits with 3 decimal places",
    "contraindications": "If provided, must be valid PostgreSQL TEXT[] array",
    "adverse_reactions": "If provided, must be valid PostgreSQL TEXT[] array",
    "ai_confidence": "Must be between 0.000 and 1.000 with 3 decimal places",
    "coding_confidence": "If provided, must be between 0.000 and 1.000 with 3 decimal places",
    "clinical_validation_status": "Must be one of: 'pending', 'validated', 'requires_review', 'rejected'",
    "expiration_date": "If provided, must be valid ISO 8601 DATE format (YYYY-MM-DD)",
    "safety_rule": "For immunizations with adverse_reactions: requires_review MUST be true"
  }
}
