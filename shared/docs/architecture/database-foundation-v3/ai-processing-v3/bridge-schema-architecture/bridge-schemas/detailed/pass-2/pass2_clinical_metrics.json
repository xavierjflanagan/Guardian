{
  "schema_version": "1.0.0",
  "table": "pass2_clinical_metrics",
  "pass": "pass-2",
  "description": "Pass 2 clinical entity extraction quality and performance metrics. This table tracks metrics for the Pass 2 AI processing pipeline including entity counts, confidence scores, bridge schema usage, token consumption, and processing costs.",
  "clinical_context": "This is a SYSTEM-GENERATED metrics table, NOT extracted from medical documents. It tracks the performance and quality of the Pass 2 clinical entity extraction process. The AI processing system populates this table automatically after completing Pass 2 extraction.",

  "required_fields": [
    "profile_id",
    "shell_file_id",
    "processing_session_id",
    "clinical_entities_enriched",
    "schemas_populated",
    "clinical_model_used",
    "clinical_tokens_used",
    "processing_time_ms"
  ],

  "fields": {
    "profile_id": {
      "type": "uuid",
      "source": "context",
      "description": "Profile identifier from processing context",
      "required": true,
      "example": "uuid-from-context",
      "guidance": "References user_profiles(id) ON DELETE CASCADE. Cross-pass join key for aggregation."
    },

    "shell_file_id": {
      "type": "uuid",
      "source": "context",
      "description": "Source document being processed",
      "required": true,
      "example": "uuid-of-processed-document",
      "guidance": "References shell_files(id) ON DELETE CASCADE. Tracks which document was processed."
    },

    "processing_session_id": {
      "type": "uuid",
      "source": "context",
      "description": "AI processing session identifier",
      "required": true,
      "example": "uuid-of-ai-session",
      "guidance": "References ai_processing_sessions(id) ON DELETE CASCADE. PRIMARY cross-pass join key for rollup analytics."
    },

    "clinical_entities_enriched": {
      "type": "integer",
      "description": "Count of clinical entities extracted in Pass 2",
      "required": true,
      "examples": [15, 8, 22],
      "guidance": "Total number of clinical entities extracted (conditions, medications, observations, etc.). Must be non-negative."
    },

    "schemas_populated": {
      "type": "array",
      "item_type": "string",
      "description": "Array of table names populated during Pass 2 extraction",
      "required": true,
      "examples": [
        ["patient_conditions", "patient_medications", "patient_observations"],
        ["patient_allergies", "patient_immunizations"],
        ["patient_conditions", "patient_medications", "patient_observations", "patient_interventions", "patient_vitals"]
      ],
      "guidance": "PostgreSQL TEXT[] array. Must use EXACT table names from database (e.g., 'patient_medications', not 'medications'). NOT NULL - must have at least one table name."
    },

    "clinical_model_used": {
      "type": "string",
      "description": "AI model name and version used for extraction",
      "required": true,
      "examples": [
        "gpt-4o-mini",
        "gpt-4o",
        "claude-3-5-sonnet-20241022",
        "gpt-4o-mini-2024-07-18"
      ],
      "guidance": "Model identifier string including version if available. Required for cost attribution and quality analysis."
    },

    "average_clinical_confidence": {
      "type": "numeric",
      "precision": 4,
      "scale": 3,
      "range": [0, 1],
      "description": "Average AI confidence across all Pass 2 extractions",
      "required": false,
      "examples": [0.920, 0.785, 0.955],
      "guidance": "NUMERIC(4,3) - 0.000-1.000 range with 3 decimal places. Calculated as mean of all entity ai_confidence scores."
    },

    "manual_review_triggered_count": {
      "type": "integer",
      "description": "Count of entities flagged for manual review",
      "required": false,
      "default": 0,
      "examples": [0, 2, 3],
      "guidance": "Count of entities where requires_review=true. Defaults to 0. Non-negative integer."
    },

    "validation_failures": {
      "type": "integer",
      "description": "Count of validation failures during extraction",
      "required": false,
      "default": 0,
      "examples": [0, 2, 1],
      "guidance": "Count of entities that failed schema validation. Defaults to 0. Non-negative integer."
    },

    "bridge_schemas_used": {
      "type": "array",
      "item_type": "string",
      "description": "Array of bridge schema names used during extraction",
      "required": false,
      "examples": [
        ["patient_conditions_detailed", "patient_medications_detailed", "patient_observations_minimal"],
        ["patient_allergies_detailed", "patient_immunizations_detailed"],
        ["patient_conditions_detailed", "patient_medications_detailed", "patient_observations_detailed", "patient_interventions_detailed", "patient_vitals_minimal"]
      ],
      "guidance": "PostgreSQL TEXT[] array. Use bridge schema identifiers (e.g., 'patient_medications_detailed' or 'patient_medications_minimal'). Consider GIN index for analytics."
    },

    "schema_loading_time_ms": {
      "type": "integer",
      "description": "Time to load bridge schemas in milliseconds",
      "required": false,
      "examples": [45, 38, 52],
      "guidance": "INTEGER type. Measures bridge schema loading performance. Non-negative."
    },

    "clinical_tokens_used": {
      "type": "integer",
      "description": "Total tokens consumed during Pass 2 extraction",
      "required": true,
      "examples": [3500, 2800, 5200],
      "guidance": "INTEGER type. Sum of input + output tokens. Required for cost calculation. Non-negative."
    },

    "processing_time_ms": {
      "type": "integer",
      "description": "Total processing time in milliseconds",
      "required": true,
      "examples": [2100, 1800, 3400],
      "guidance": "INTEGER type. End-to-end Pass 2 processing duration. Required for performance analysis. Non-negative."
    },

    "cost_usd": {
      "type": "numeric",
      "precision": 8,
      "scale": 4,
      "description": "Processing cost in USD",
      "required": false,
      "examples": [0.0042, 0.0034, 0.0156],
      "guidance": "NUMERIC(8,4) - up to $9,999.9999 with 4 decimal places. Calculated from tokens_used and model pricing. Non-negative."
    },

    "user_agent": {
      "type": "string",
      "description": "User agent string from processing request",
      "required": false,
      "examples": ["Mozilla/5.0...", "Guardian-Worker/1.0"],
      "guidance": "Optional metadata for debugging and analytics."
    },

    "ip_address": {
      "type": "inet",
      "description": "IP address of processing request",
      "required": false,
      "examples": ["192.168.1.1", "2001:0db8:85a3:0000:0000:8a2e:0370:7334"],
      "guidance": "PostgreSQL INET type. Supports both IPv4 and IPv6. Optional metadata for security and analytics."
    }
  },

  "examples": [
    {
      "description": "Successful Pass 2 extraction with high confidence",
      "extraction": {
        "profile_id": "uuid-from-context",
        "shell_file_id": "uuid-of-processed-document",
        "processing_session_id": "uuid-of-ai-session",
        "clinical_entities_enriched": 15,
        "schemas_populated": ["patient_conditions", "patient_medications", "patient_observations"],
        "clinical_model_used": "gpt-4o-mini",
        "average_clinical_confidence": 0.920,
        "manual_review_triggered_count": 2,
        "validation_failures": 0,
        "bridge_schemas_used": ["patient_conditions_detailed", "patient_medications_detailed", "patient_observations_minimal"],
        "schema_loading_time_ms": 45,
        "clinical_tokens_used": 3500,
        "processing_time_ms": 2100,
        "cost_usd": 0.0042
      }
    },
    {
      "description": "Processing with validation issues and lower confidence",
      "extraction": {
        "profile_id": "uuid-from-context",
        "shell_file_id": "uuid-of-processed-document",
        "processing_session_id": "uuid-of-ai-session",
        "clinical_entities_enriched": 8,
        "schemas_populated": ["patient_allergies", "patient_immunizations"],
        "clinical_model_used": "gpt-4o-mini",
        "average_clinical_confidence": 0.785,
        "manual_review_triggered_count": 3,
        "validation_failures": 2,
        "bridge_schemas_used": ["patient_allergies_detailed", "patient_immunizations_detailed"],
        "schema_loading_time_ms": 38,
        "clinical_tokens_used": 2800,
        "processing_time_ms": 1800,
        "cost_usd": 0.0034
      }
    },
    {
      "description": "High-quality extraction using GPT-4o",
      "extraction": {
        "profile_id": "uuid-from-context",
        "shell_file_id": "uuid-of-processed-document",
        "processing_session_id": "uuid-of-ai-session",
        "clinical_entities_enriched": 22,
        "schemas_populated": ["patient_conditions", "patient_medications", "patient_observations", "patient_interventions", "patient_vitals"],
        "clinical_model_used": "gpt-4o",
        "average_clinical_confidence": 0.955,
        "manual_review_triggered_count": 0,
        "validation_failures": 0,
        "bridge_schemas_used": ["patient_conditions_detailed", "patient_medications_detailed", "patient_observations_detailed", "patient_interventions_detailed", "patient_vitals_minimal"],
        "schema_loading_time_ms": 52,
        "clinical_tokens_used": 5200,
        "processing_time_ms": 3400,
        "cost_usd": 0.0156
      }
    }
  ],

  "extraction_guidelines": {
    "system_generated": "This table is populated AUTOMATICALLY by the AI processing system after Pass 2 completion. It is NOT extracted from medical documents.",
    "required_fields_strict": "All 8 required fields (profile_id, shell_file_id, processing_session_id, clinical_entities_enriched, schemas_populated, clinical_model_used, clinical_tokens_used, processing_time_ms) must be provided.",
    "schemas_populated_naming": "Must use EXACT database table names (e.g., 'patient_medications', NOT 'medications'). Case-sensitive.",
    "bridge_schemas_naming": "Must use bridge schema identifiers with tier suffix (e.g., 'patient_medications_detailed' or 'patient_medications_minimal').",
    "cross_pass_consistency": "Use consistent field names and precisions across Pass 1, Pass 2, and Pass 3 metrics tables for aggregation.",
    "processing_session_id_key": "PRIMARY join key for cross-pass analytics. All passes share the same processing_session_id for a given pipeline run.",
    "cost_calculation": "cost_usd calculated from clinical_tokens_used × model_price_per_token. Precision allows costs up to $9,999.9999.",
    "quality_indicators": {
      "high_quality": "average_clinical_confidence >= 0.900 AND validation_failures = 0",
      "moderate_quality": "average_clinical_confidence 0.700-0.899 OR validation_failures <= 2",
      "low_quality": "average_clinical_confidence < 0.700 OR validation_failures > 2 OR manual_review_triggered_count > clinical_entities_enriched * 0.5"
    },
    "performance_optimization": "Consider GIN indexes on schemas_populated and bridge_schemas_used arrays for analytics queries filtering by table names."
  },

  "interoperability_notes": {
    "pass1_pass3_parity": "Mirror this contract in Pass 1 and Pass 3 metrics tables. Use consistent keys (profile_id, shell_file_id, processing_session_id) and datatypes.",
    "naming_alignment": "Pass 1: 'entities_detected', Pass 2: 'clinical_entities_enriched', Pass 3: 'narratives_generated'. Consider adding common 'entities_count' field.",
    "session_hierarchy": "processing_session_id is cross-pass join key. If separate sessions per pass, add pipeline_run_id for rollups.",
    "summary_layer": "Create materialized view aggregating across passes per processing_session_id and per profile_id (total counts, durations, tokens, cost, avg confidences).",
    "analytics_indexes": "GIN indexes on TEXT[] arrays enable efficient filtering: CREATE INDEX idx_schemas_populated ON pass2_clinical_metrics USING GIN(schemas_populated);"
  },

  "validation_rules": {
    "profile_id": "Must be valid UUID (NOT NULL)",
    "shell_file_id": "Must be valid UUID (NOT NULL)",
    "processing_session_id": "Must be valid UUID (NOT NULL)",
    "clinical_entities_enriched": "Must be non-negative integer (NOT NULL)",
    "schemas_populated": "Must be valid TEXT[] array with at least one exact table name (NOT NULL)",
    "clinical_model_used": "Must be provided (NOT NULL)",
    "clinical_tokens_used": "Must be non-negative integer (NOT NULL)",
    "processing_time_ms": "Must be non-negative integer (NOT NULL)",
    "average_clinical_confidence": "If provided, must be between 0.000 and 1.000 with 3 decimal places",
    "manual_review_triggered_count": "If provided, must be non-negative integer",
    "validation_failures": "If provided, must be non-negative integer",
    "bridge_schemas_used": "If provided, must be valid TEXT[] array with bridge schema identifiers",
    "schema_loading_time_ms": "If provided, must be non-negative integer",
    "cost_usd": "If provided, must be non-negative number with max 4 decimal places",
    "ip_address": "If provided, must be valid IPv4 or IPv6 format"
  }
}
