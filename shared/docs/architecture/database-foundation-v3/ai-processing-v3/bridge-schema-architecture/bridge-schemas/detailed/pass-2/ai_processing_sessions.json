{
  "schema_version": "1.0.0",
  "table": "ai_processing_sessions",
  "pass": "pass-2",
  "operation": "UPDATE",
  "description": "Pass 2 UPDATE operation for ai_processing_sessions. Updates existing session with clinical enrichment status and completion metrics.",

  "fields_updated_by_pass2": {
    "session_status": {
      "type": "enum",
      "values": ["completed", "failed"],
      "examples": ["completed", "failed"],
      "guidance": "Update to 'completed' after successful enrichment, or 'failed' on error."
    },
    "workflow_step": {
      "type": "enum",
      "values": ["clinical_extraction", "completed"],
      "examples": ["completed"],
      "guidance": "Advance from 'entity_detection' → 'clinical_extraction' → 'completed'."
    },
    "completed_steps": {
      "type": "integer",
      "examples": [5],
      "guidance": "Increment or set to total_steps when all done."
    },
    "overall_confidence": {
      "type": "numeric",
      "precision": 4,
      "scale": 3,
      "examples": [0.920],
      "guidance": "May update with Pass 2 clinical confidence. Use COALESCE to preserve existing."
    },
    "quality_score": {
      "type": "numeric",
      "precision": 4,
      "scale": 3,
      "examples": [0.885],
      "guidance": "Update with Pass 2 quality metrics."
    },
    "processing_completed_at": {
      "type": "timestamptz",
      "examples": ["2025-01-01T12:36:22Z"],
      "guidance": "Set when Pass 2 finishes."
    },
    "total_processing_time": {
      "type": "interval",
      "examples": ["00:01:26"],
      "guidance": "Calculate: processing_completed_at - processing_started_at. INTERVAL type."
    },
    "error_message": {
      "type": "string",
      "examples": ["Clinical enrichment failed - insufficient clinical entities"],
      "guidance": "Populate if Pass 2 fails."
    },
    "error_context": {
      "type": "jsonb",
      "examples": [{"entities_detected": 3, "enrichment_threshold": 5, "pass": "pass-2"}],
      "guidance": "Include pass='pass-2' if Pass 2 fails."
    },
    "retry_count": {
      "type": "integer",
      "examples": [1],
      "guidance": "Increment if retrying: retry_count = retry_count + 1."
    }
  },

  "fields_not_modified_by_pass2": ["patient_id", "shell_file_id", "session_type", "ai_model_name", "model_config", "processing_mode", "total_steps", "processing_started_at", "max_retries"],
  "migration_notes": "MIGRATION 23 (2025-10-12): ai_model_version renamed to ai_model_name for semantic clarity",

  "examples": [
    {
      "description": "Successful completion",
      "update": {
        "session_status": "completed",
        "workflow_step": "completed",
        "completed_steps": 5,
        "overall_confidence": 0.920,
        "quality_score": 0.885,
        "processing_completed_at": "2025-01-01T12:36:22Z",
        "total_processing_time": "00:01:26"
      }
    },
    {
      "description": "Failed enrichment",
      "update": {
        "session_status": "failed",
        "workflow_step": "clinical_extraction",
        "processing_completed_at": "2025-01-15T09:32:10Z",
        "total_processing_time": "00:01:48",
        "error_message": "Clinical enrichment failed",
        "error_context": {"pass": "pass-2"}
      }
    }
  ],

  "update_guidelines": {
    "operation": "UPDATE existing session (Pass 1 created it)",
    "idempotency": "Use WHERE session_status = 'processing' guard",
    "readonly_pass1": "Do NOT modify patient_id, shell_file_id, session_type, processing_started_at"
  }
}
