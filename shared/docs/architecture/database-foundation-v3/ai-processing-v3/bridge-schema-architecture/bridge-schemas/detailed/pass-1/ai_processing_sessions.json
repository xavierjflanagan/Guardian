{
  "schema_version": "1.0.0",
  "table": "ai_processing_sessions",
  "pass": "pass-1",
  "operation": "CREATE",
  "description": "Pass 1 CREATE operation for ai_processing_sessions. Creates session coordination record and tracks entity detection progress. Multi-pass table: Pass 1 creates, Pass 2 updates with clinical enrichment status.",

  "required_fields": [
    "patient_id",
    "shell_file_id",
    "session_type"
  ],

  "fields": {
    "patient_id": {
      "type": "uuid",
      "source": "context",
      "required": true,
      "example": "uuid-of-patient",
      "guidance": "References user_profiles(id) ON DELETE CASCADE. Which patient this session processes."
    },

    "shell_file_id": {
      "type": "uuid",
      "source": "context",
      "required": true,
      "example": "uuid-of-shell-file",
      "guidance": "References shell_files(id) ON DELETE CASCADE. Which file is being processed."
    },

    "session_type": {
      "type": "enum",
      "values": ["shell_file_processing", "entity_extraction", "clinical_validation", "profile_classification", "decision_support", "semantic_processing"],
      "required": true,
      "examples": ["shell_file_processing", "profile_classification"],
      "guidance": "Type of processing session. Pass 1 typically uses 'shell_file_processing' or 'entity_extraction'."
    },

    "session_status": {
      "type": "enum",
      "values": ["initiated", "processing", "completed", "failed", "cancelled"],
      "default": "initiated",
      "examples": ["processing", "failed"],
      "guidance": "NOT NULL with default 'initiated'. Pass 1 updates to 'processing' during entity detection."
    },

    "ai_model_version": {
      "type": "string",
      "default": "v3",
      "examples": ["v3"],
      "guidance": "NOT NULL with default 'v3'. AI model version identifier."
    },

    "model_config": {
      "type": "jsonb",
      "default": "{}",
      "examples": [{"vision_model": "gpt-4o", "ocr_provider": "google-cloud-vision"}],
      "guidance": "JSONB object. AI model parameters and configuration. Defaults to empty object."
    },

    "processing_mode": {
      "type": "enum",
      "values": ["automated", "human_guided", "validation_only"],
      "examples": ["automated"],
      "guidance": "Processing approach. Pass 1 typically uses 'automated'."
    },

    "workflow_step": {
      "type": "enum",
      "values": ["entity_detection", "profile_classification", "clinical_extraction", "semantic_processing", "validation", "decision_support", "completed"],
      "default": "entity_detection",
      "examples": ["entity_detection", "profile_classification"],
      "guidance": "NOT NULL with default 'entity_detection'. Pass 1 uses entity_detection/profile_classification."
    },

    "total_steps": {
      "type": "integer",
      "default": 5,
      "examples": [5, 3],
      "guidance": "Total workflow steps. Defaults to 5."
    },

    "completed_steps": {
      "type": "integer",
      "default": 0,
      "examples": [1, 2],
      "guidance": "Steps completed so far. Pass 1 increments during entity detection. Defaults to 0."
    },

    "overall_confidence": {
      "type": "numeric",
      "precision": 4,
      "scale": 3,
      "range": [0, 1],
      "examples": [0.850, 0.920],
      "guidance": "NUMERIC(4,3). Average confidence across Pass 1 entity detection. 0.000-1.000."
    },

    "requires_human_review": {
      "type": "boolean",
      "default": false,
      "examples": [false, true],
      "guidance": "Flag for manual review. Pass 1 sets true if contamination risk detected."
    },

    "quality_score": {
      "type": "numeric",
      "precision": 4,
      "scale": 3,
      "range": [0, 1],
      "examples": [0.875],
      "guidance": "NUMERIC(4,3). Overall quality score from Pass 1. 0.000-1.000."
    },

    "processing_started_at": {
      "type": "timestamptz",
      "default": "NOW()",
      "examples": ["2025-01-01T12:34:56Z"],
      "guidance": "NOT NULL with default NOW(). When session started."
    },

    "processing_completed_at": {
      "type": "timestamptz",
      "default": null,
      "guidance": "Pass 1 leaves NULL unless session fails. Pass 2 sets on completion."
    },

    "total_processing_time": {
      "type": "interval",
      "default": null,
      "examples": ["00:01:33"],
      "guidance": "PostgreSQL INTERVAL. Pass 1 leaves NULL unless session fails. Pass 2 calculates."
    },

    "error_message": {
      "type": "string",
      "examples": ["Entity detection failed - document quality too low"],
      "guidance": "TEXT. Populated if Pass 1 fails."
    },

    "error_context": {
      "type": "jsonb",
      "examples": [{"ocr_confidence": 0.35, "entities_detected": 0, "pass": "pass-1"}],
      "guidance": "JSONB object. Include pass='pass-1' if Pass 1 fails."
    },

    "retry_count": {
      "type": "integer",
      "default": 0,
      "examples": [0, 2],
      "guidance": "Number of retry attempts. Defaults to 0."
    },

    "max_retries": {
      "type": "integer",
      "default": 3,
      "examples": [3],
      "guidance": "Maximum retry attempts. Defaults to 3."
    }
  },

  "extraction_guidelines": {
    "operation": "CREATE new ai_processing_sessions record for entity detection",
    "required_strict": "patient_id, shell_file_id, session_type must be provided",
    "defaults": "session_status='initiated', workflow_step='entity_detection', ai_model_version='v3'",
    "pass1_responsibility": "Track entity detection progress, set overall_confidence from entity detection results",
    "completion_fields_null": "processing_completed_at and total_processing_time remain NULL unless session fails"
  },

  "validation_rules": {
    "patient_id": "Must be valid UUID (NOT NULL)",
    "shell_file_id": "Must be valid UUID (NOT NULL)",
    "session_type": "Must be one of 6 enum values (NOT NULL)",
    "session_status": "Must be one of 5 enum values (defaults to 'initiated')",
    "workflow_step": "Must be one of 7 enum values (defaults to 'entity_detection')",
    "overall_confidence": "If provided, must be 0.000-1.000 with 3 decimal places",
    "quality_score": "If provided, must be 0.000-1.000 with 3 decimal places"
  }
}
