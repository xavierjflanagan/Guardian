{
  "schema_version": "1.0.0",
  "table": "healthcare_encounters",
  "pass": "pass-2",
  "description": "Healthcare encounters and provider visits. This table stores information about patient interactions with healthcare providers, including office visits, hospital admissions, emergency visits, specialist consultations, telehealth appointments, and diagnostic procedures.",
  "clinical_context": "Use this schema for extracting healthcare encounter information from medical documents such as visit notes, discharge summaries, clinic records, consultation notes, and procedure reports. Encounters represent the context and setting in which clinical care was delivered.",

  "required_fields": [
    "patient_id",
    "encounter_type"
  ],

  "fields": {
    "patient_id": {
      "type": "uuid",
      "source": "context",
      "description": "Patient identifier from processing context",
      "required": true,
      "example": "uuid-from-context",
      "guidance": "References user_profiles(id). Required for RLS policies and data isolation."
    },

    "encounter_type": {
      "type": "text",
      "description": "Setting/context of the healthcare visit (NOT NULL - required field)",
      "required": true,
      "allowed_values": ["outpatient", "inpatient", "emergency", "specialist", "telehealth", "diagnostic"],
      "type_definitions": {
        "outpatient": "Standard clinic or office visit (routine check-ups, follow-ups)",
        "inpatient": "Hospital admission requiring overnight stay (surgery, serious illness)",
        "emergency": "Emergency department or urgent care visit",
        "specialist": "Consultation with medical specialist (cardiologist, dermatologist, etc.)",
        "telehealth": "Virtual consultation via video, phone, or other remote technology",
        "diagnostic": "Visit focused on testing, imaging, or screening procedures"
      },
      "selection_guide": {
        "outpatient": ["office visit", "clinic appointment", "routine check-up", "follow-up visit"],
        "inpatient": ["admitted to hospital", "inpatient stay", "hospitalization"],
        "emergency": ["ER visit", "emergency department", "urgent care", "emergency room"],
        "specialist": ["cardiologist", "dermatologist", "oncologist", "specialist consultation"],
        "telehealth": ["telemedicine", "video visit", "phone consultation", "virtual appointment"],
        "diagnostic": ["lab work", "X-ray", "MRI", "CT scan", "screening", "imaging"]
      },
      "guidance": "Required field. Select based on document keywords and clinical context."
    },

    "encounter_date": {
      "type": "timestamptz",
      "format": "ISO 8601",
      "description": "Date and time when the encounter occurred",
      "required": false,
      "examples": [
        "2025-09-30T14:00:00Z",
        "2025-09-15T10:30:00-05:00"
      ],
      "guidance": "Extract the date/time of the actual healthcare encounter. Use full timestamp with timezone if available."
    },

    "provider_name": {
      "type": "text",
      "description": "Name of the healthcare provider who performed the encounter",
      "required": false,
      "examples": [
        "Dr. Sarah Johnson",
        "Dr. Michael Chen",
        "Dr. Lisa Wong",
        "Emma Taylor, NP"
      ],
      "guidance": "Extract individual provider name. Include credentials if stated (MD, NP, PA, etc.)."
    },

    "provider_type": {
      "type": "text",
      "description": "Classification of the healthcare provider",
      "required": false,
      "common_values": ["primary_care", "specialist", "hospital", "urgent_care"],
      "type_definitions": {
        "primary_care": "General practitioner, family doctor, internal medicine",
        "specialist": "Specialist physician (cardiologist, dermatologist, oncologist, etc.)",
        "hospital": "Hospital-based care team or attending physician",
        "urgent_care": "Urgent care or walk-in clinic provider"
      },
      "guidance": "Classify provider based on their role and practice setting. Not required if unclear."
    },

    "facility_name": {
      "type": "text",
      "description": "Name of the healthcare facility where encounter occurred",
      "required": false,
      "examples": [
        "Melbourne Family Medical Centre",
        "Sydney Heart Clinic",
        "Royal Brisbane Emergency Department",
        "Melbourne Imaging Centre"
      ],
      "guidance": "Extract institution/facility name. Can be clinic, hospital, imaging center, etc."
    },

    "specialty": {
      "type": "text",
      "description": "Medical specialty of the provider or encounter focus",
      "required": false,
      "examples": [
        "family_medicine",
        "cardiology",
        "dermatology",
        "radiology",
        "emergency_medicine",
        "internal_medicine"
      ],
      "guidance": "Extract medical specialty from document. Useful for specialist and diagnostic encounters."
    },

    "chief_complaint": {
      "type": "text",
      "description": "Patient's primary reason for the visit or main concern",
      "required": false,
      "examples": [
        "Annual physical examination",
        "Follow-up for hypertension management",
        "Severe chest pain",
        "Upper respiratory symptoms",
        "Scheduled chest X-ray"
      ],
      "guidance": "Extract the patient's stated reason for visit. Often appears in 'Chief Complaint' or 'Reason for Visit' section."
    },

    "summary": {
      "type": "text",
      "description": "Brief summary or overview of the encounter",
      "required": false,
      "examples": [
        "Routine annual check-up. Patient reports feeling well. No new concerns.",
        "Patient's blood pressure remains elevated despite medication adjustments",
        "Video consultation for cough and congestion"
      ],
      "guidance": "Extract visit summary, typically 1-3 sentences capturing the key points of the encounter."
    },

    "clinical_impression": {
      "type": "text",
      "description": "Provider's clinical assessment or diagnosis",
      "required": false,
      "examples": [
        "Healthy adult with well-controlled hypertension",
        "Resistant hypertension, recommend additional testing",
        "Rule out myocardial infarction",
        "Viral upper respiratory infection"
      ],
      "guidance": "Extract provider's assessment, diagnosis, or clinical impression from document."
    },

    "plan": {
      "type": "text",
      "description": "Treatment plan or next steps recommended by provider",
      "required": false,
      "examples": [
        "Continue current medications. Follow-up in 12 months.",
        "Order echocardiogram, adjust medication regimen",
        "Admitted for observation, cardiology consult ordered",
        "Symptomatic treatment, follow up if symptoms worsen"
      ],
      "guidance": "Extract treatment plan, follow-up instructions, or recommendations from document."
    },

    "visit_duration_minutes": {
      "type": "integer",
      "description": "Duration of the encounter in minutes",
      "required": false,
      "examples": [15, 30, 45, 180],
      "guidance": "Extract if explicitly stated in document. Common for billing or scheduling records."
    },

    "billing_codes": {
      "type": "text[]",
      "description": "Array of billing codes (CPT, MBS) associated with the encounter",
      "required": false,
      "examples": [
        ["23", "73"],
        ["99213", "85025"],
        ["58100"]
      ],
      "guidance": "Extract billing/procedure codes if present. Use TEXT[] array format. Common for Australian MBS or US CPT codes."
    },

    "primary_shell_file_id": {
      "type": "uuid",
      "description": "Primary source document for this encounter",
      "required": false,
      "example": "uuid-from-context",
      "guidance": "References shell_files(id). Link to the main document from which this encounter was extracted."
    },

    "related_shell_file_ids": {
      "type": "uuid[]",
      "description": "Array of related/supporting documents for this encounter",
      "required": false,
      "default": "{}",
      "example": ["uuid-1", "uuid-2", "uuid-3"],
      "guidance": "Use UUID[] array format for multiple related documents (lab results, imaging reports, etc.)."
    },

    "ai_extracted": {
      "type": "boolean",
      "description": "Always true for AI-extracted encounters",
      "required": true,
      "default": false,
      "guidance": "Set to true for all Pass 2 AI extractions. Distinguishes AI-extracted from manually entered encounters."
    },

    "ai_confidence": {
      "type": "numeric",
      "precision": 4,
      "scale": 3,
      "range": [0, 1],
      "description": "AI confidence in the extraction (0.000-1.000)",
      "required": true,
      "examples": [0.920, 0.890, 0.950],
      "confidence_guidance": {
        "high": ">= 0.900 - Clear encounter information, all key fields present",
        "medium": "0.700 - 0.899 - Reasonable extraction, some fields may be unclear",
        "low": "< 0.700 - Uncertain extraction, requires review"
      },
      "guidance": "Be honest about extraction confidence. Consider completeness, clarity, and ambiguity."
    },

    "requires_review": {
      "type": "boolean",
      "description": "Flag if this encounter needs human review",
      "required": true,
      "default": false,
      "guidance": "Set to true if ai_confidence < 0.700, or if encounter_type classification is uncertain, or if critical fields are ambiguous."
    },

    "confidence_score": {
      "type": "numeric",
      "precision": 4,
      "scale": 3,
      "range": [0, 1],
      "description": "Overall quality/confidence score for the encounter (0.000-1.000)",
      "required": false,
      "examples": [0.920, 0.850, 0.780],
      "guidance": "Composite confidence considering completeness and clarity of all encounter fields.",
      "note": "Same precision as ai_confidence (NUMERIC(4,3))"
    },

    "archived": {
      "type": "boolean",
      "description": "Whether this encounter has been archived (NOT NULL)",
      "required": false,
      "default": false,
      "guidance": "Defaults to false. Set to true to soft-delete/archive the encounter."
    },

    "clinical_event_id": {
      "type": "uuid",
      "description": "Links to patient_clinical_events (temporal management)",
      "required": false,
      "example": "uuid-of-parent-clinical-event",
      "guidance": "Part of temporal management system. Optional for Pass 2."
    },

    "primary_narrative_id": {
      "type": "uuid",
      "description": "Links to clinical_narratives (Pass 3 semantic processing)",
      "required": false,
      "default": null,
      "guidance": "Leave null in Pass 2. Populated by Pass 3 when semantic narratives are created."
    },

    "clinical_effective_date": {
      "type": "date",
      "format": "ISO 8601 (YYYY-MM-DD)",
      "description": "Clinical relevance date (when encounter occurred)",
      "required": false,
      "examples": ["2025-09-30", "2024-12-15"],
      "guidance": "Extract the date of the encounter. Typically same date as encounter_date but in DATE format."
    },

    "date_confidence": {
      "type": "enum",
      "values": ["high", "medium", "low", "conflicted"],
      "description": "Confidence in the extracted date",
      "required": false,
      "confidence_levels": {
        "high": "Date explicitly stated and unambiguous",
        "medium": "Date inferred with reasonable confidence",
        "low": "Date uncertain or partially missing",
        "conflicted": "Multiple conflicting dates found"
      }
    },

    "extracted_dates": {
      "type": "jsonb",
      "description": "Array of all date extraction attempts for audit trail",
      "required": false,
      "default": [],
      "example": [
        {"date": "2025-09-30", "source": "clinical_content", "confidence": 0.95},
        {"date": "2025-09-28", "source": "document_date", "confidence": 0.70}
      ]
    },

    "date_source": {
      "type": "enum",
      "values": ["clinical_content", "document_date", "file_metadata", "upload_timestamp", "user_provided"],
      "description": "Where the date was extracted from",
      "required": false,
      "source_priority": {
        "clinical_content": "Highest priority - date stated in clinical text",
        "document_date": "Document creation/modification date",
        "file_metadata": "File system metadata",
        "upload_timestamp": "When file was uploaded",
        "user_provided": "User manually specified date"
      }
    },

    "date_conflicts": {
      "type": "jsonb",
      "description": "Array of conflicting dates found during extraction",
      "required": false,
      "default": [],
      "example": [
        {"date": "2025-09-30", "source": "clinical_content"},
        {"date": "2025-09-28", "source": "document_date"}
      ]
    },

    "date_resolution_reason": {
      "type": "string",
      "description": "Explanation of why this date was chosen when conflicts exist",
      "required": false,
      "example": "Selected clinical content date as it explicitly states encounter date"
    },

    "clinical_identity_key": {
      "type": "string",
      "description": "Deduplication fingerprint for identifying duplicate encounters",
      "required": false,
      "example": "encounter_outpatient_2025-09-30_dr-johnson_melbourne-family",
      "guidance": "Create a stable key combining encounter_type, date, provider, and facility for duplicate detection."
    },

    "created_at": {
      "type": "timestamptz",
      "format": "ISO 8601",
      "description": "Record creation timestamp",
      "required": false,
      "default": "NOW()",
      "guidance": "Auto-generated by database. Tracks when record was first created."
    },

    "updated_at": {
      "type": "timestamptz",
      "format": "ISO 8601",
      "description": "Record last update timestamp",
      "required": false,
      "default": "NOW()",
      "guidance": "Defaults to NOW() on insert. Update this timestamp via application logic (or a future trigger) when modifying records."
    }
  },

  "examples": [
    {
      "description": "Outpatient visit with comprehensive details",
      "extraction": {
        "patient_id": "uuid-from-context",
        "encounter_type": "outpatient",
        "encounter_date": "2025-09-30T14:00:00Z",
        "provider_name": "Dr. Sarah Johnson",
        "provider_type": "primary_care",
        "facility_name": "Melbourne Family Medical Centre",
        "specialty": "family_medicine",
        "chief_complaint": "Annual physical examination",
        "summary": "Routine annual check-up. Patient reports feeling well. No new concerns.",
        "clinical_impression": "Healthy adult with well-controlled hypertension",
        "plan": "Continue current medications. Follow-up in 12 months.",
        "visit_duration_minutes": 30,
        "billing_codes": ["23", "73"],
        "primary_shell_file_id": "uuid-from-context",
        "ai_extracted": true,
        "ai_confidence": 0.920,
        "requires_review": false,
        "confidence_score": 0.920,
        "archived": false,
        "clinical_effective_date": "2025-09-30",
        "date_confidence": "high",
        "date_source": "clinical_content"
      }
    },
    {
      "description": "Specialist cardiology consultation",
      "extraction": {
        "patient_id": "uuid-from-context",
        "encounter_type": "specialist",
        "encounter_date": "2025-09-15T10:30:00Z",
        "provider_name": "Dr. Michael Chen",
        "provider_type": "specialist",
        "facility_name": "Sydney Heart Clinic",
        "specialty": "cardiology",
        "chief_complaint": "Follow-up for hypertension management",
        "summary": "Patient's blood pressure remains elevated despite medication adjustments",
        "clinical_impression": "Resistant hypertension, recommend additional testing",
        "plan": "Order echocardiogram, adjust medication regimen",
        "visit_duration_minutes": 45,
        "primary_shell_file_id": "uuid-from-context",
        "ai_extracted": true,
        "ai_confidence": 0.890,
        "requires_review": false,
        "clinical_effective_date": "2025-09-15",
        "date_confidence": "high"
      }
    },
    {
      "description": "Emergency department visit",
      "extraction": {
        "patient_id": "uuid-from-context",
        "encounter_type": "emergency",
        "encounter_date": "2025-09-20T03:15:00Z",
        "provider_name": "Dr. Lisa Wong",
        "provider_type": "hospital",
        "facility_name": "Royal Brisbane Emergency Department",
        "chief_complaint": "Severe chest pain",
        "summary": "Patient presented with acute chest pain. ECG performed, cardiac markers ordered.",
        "clinical_impression": "Rule out myocardial infarction",
        "plan": "Admitted for observation, cardiology consult ordered",
        "visit_duration_minutes": 180,
        "primary_shell_file_id": "uuid-from-context",
        "ai_extracted": true,
        "ai_confidence": 0.950,
        "requires_review": false,
        "clinical_effective_date": "2025-09-20",
        "date_confidence": "high"
      }
    },
    {
      "description": "Telehealth consultation",
      "extraction": {
        "patient_id": "uuid-from-context",
        "encounter_type": "telehealth",
        "encounter_date": "2025-09-25T16:00:00Z",
        "provider_name": "Dr. Emma Taylor",
        "provider_type": "primary_care",
        "specialty": "family_medicine",
        "chief_complaint": "Upper respiratory symptoms",
        "summary": "Video consultation for cough and congestion",
        "clinical_impression": "Viral upper respiratory infection",
        "plan": "Symptomatic treatment, follow up if symptoms worsen",
        "visit_duration_minutes": 15,
        "primary_shell_file_id": "uuid-from-context",
        "ai_extracted": true,
        "ai_confidence": 0.880,
        "requires_review": false,
        "clinical_effective_date": "2025-09-25",
        "date_confidence": "high"
      }
    },
    {
      "description": "Diagnostic imaging encounter",
      "extraction": {
        "patient_id": "uuid-from-context",
        "encounter_type": "diagnostic",
        "encounter_date": "2025-09-28T09:00:00Z",
        "facility_name": "Melbourne Imaging Centre",
        "specialty": "radiology",
        "chief_complaint": "Scheduled chest X-ray",
        "summary": "Routine chest X-ray as ordered by primary care physician",
        "visit_duration_minutes": 20,
        "billing_codes": ["58100"],
        "primary_shell_file_id": "uuid-from-context",
        "ai_extracted": true,
        "ai_confidence": 0.910,
        "requires_review": false,
        "clinical_effective_date": "2025-09-28",
        "date_confidence": "high"
      }
    }
  ],

  "extraction_guidelines": {
    "encounter_type_selection": "Required field. Use selection guide to map document keywords to encounter types. When uncertain, prefer more general types (outpatient > specialist, specialist > inpatient).",
    "narrative_fields": "chief_complaint, summary, clinical_impression, and plan capture narrative clinical content. Extract verbatim or summarize key points.",
    "provider_vs_facility": "provider_name is the individual provider, facility_name is the institution. Extract both when available.",
    "billing_codes": "Use TEXT[] array format. Common codes: MBS (Australia), CPT (US). Extract if present in document.",
    "confidence_thresholds": {
      "high_confidence": ">= 0.900 for clear encounters with key fields",
      "medium_confidence": "0.700-0.899 for incomplete but reasonable extractions",
      "requires_review": "< 0.700 or uncertain encounter_type classification"
    },
    "date_extraction": "Prefer encounter_date (TIMESTAMPTZ) with time if available. Also populate clinical_effective_date (DATE) for timeline queries.",
    "temporal_management": "clinical_identity_key used for deduplication. Combine encounter_type, date, provider, facility for stable fingerprint."
  },

  "validation_rules": {
    "encounter_type": "Must be exactly one of: 'outpatient', 'inpatient', 'emergency', 'specialist', 'telehealth', 'diagnostic'",
    "patient_id": "Must be valid UUID referencing user_profiles(id)",
    "ai_confidence": "Must be between 0.000 and 1.000 with 3 decimal places (NUMERIC(4,3))",
    "confidence_score": "If provided, must be between 0.000 and 1.000 with 3 decimal places",
    "billing_codes": "If provided, must be TEXT[] array format",
    "related_shell_file_ids": "If provided, must be UUID[] array format",
    "archived": "Must be boolean, NOT NULL (defaults to false)",
    "date_confidence": "If provided, must be one of: 'high', 'medium', 'low', 'conflicted'",
    "date_source": "If provided, must be one of: 'clinical_content', 'document_date', 'file_metadata', 'upload_timestamp', 'user_provided'"
  }
}