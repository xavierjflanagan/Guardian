{
  "schema_version": "1.0.0",
  "table": "entity_processing_audit",
  "pass": "pass-2",
  "operation": "UPDATE",
  "description": "Pass 2 UPDATE operation for entity_processing_audit. Updates existing audit record with clinical enrichment results and links to final clinical tables. Completes the audit trail from entity detection to clinical data storage.",

  "fields_updated_by_pass2": {
    "pass2_status": {
      "type": "enum",
      "values": ["in_progress", "completed", "failed"],
      "examples": ["completed", "failed"],
      "guidance": "Update from 'pending' to final status. 'in_progress' is optional intermediate state."
    },

    "pass2_confidence": {
      "type": "numeric",
      "precision": 4,
      "scale": 3,
      "range": [0, 1],
      "examples": [0.920, 0.850],
      "guidance": "NUMERIC(4,3). Clinical enrichment confidence. 0.000-1.000. Optional but recommended."
    },

    "pass2_started_at": {
      "type": "timestamptz",
      "examples": ["2025-01-01T12:35:10Z"],
      "guidance": "Set ONCE when Pass 2 begins. Use COALESCE to avoid overwriting. ISO 8601 with timezone."
    },

    "pass2_completed_at": {
      "type": "timestamptz",
      "examples": ["2025-01-01T12:35:18Z"],
      "guidance": "Set when Pass 2 finishes (success or failure). Must be >= pass2_started_at. ISO 8601 with timezone."
    },

    "enrichment_errors": {
      "type": "string",
      "examples": ["Insufficient context for clinical classification - missing date information"],
      "guidance": "TEXT. Populate if Pass 2 fails. Diagnostic message for troubleshooting."
    },

    "pass2_model_used": {
      "type": "string",
      "examples": ["gpt-4o-mini", "claude-3-5-sonnet"],
      "guidance": "AI model used for clinical enrichment. Optional but recommended for audit trail."
    },

    "pass2_token_usage": {
      "type": "integer",
      "examples": [2400, 1200],
      "guidance": "Token consumption for Pass 2 processing. Optional but recommended for cost tracking."
    },

    "pass2_cost_estimate": {
      "type": "numeric",
      "precision": 8,
      "scale": 4,
      "examples": [0.0062, 0.0031],
      "guidance": "NUMERIC(8,4). Cost estimate for Pass 2 processing. Optional but recommended for monitoring."
    },

    "final_event_id": {
      "type": "uuid",
      "examples": ["uuid-of-clinical-event-record"],
      "guidance": "UUID link to patient_clinical_events(id). Populate for clinical events. May link with other final_* fields."
    },

    "final_encounter_id": {
      "type": "uuid",
      "examples": ["uuid-of-encounter-record"],
      "guidance": "UUID link to healthcare_encounters(id). Populate for appointments/visits."
    },

    "final_observation_id": {
      "type": "uuid",
      "examples": ["uuid-of-observation-record"],
      "guidance": "UUID link to patient_observations(id). Populate for vital signs, lab results, observations."
    },

    "final_intervention_id": {
      "type": "uuid",
      "examples": ["uuid-of-intervention-record"],
      "guidance": "UUID link to patient_interventions(id). Populate for medications, procedures, immunizations."
    },

    "final_condition_id": {
      "type": "uuid",
      "examples": ["uuid-of-condition-record"],
      "guidance": "UUID link to patient_conditions(id). Populate for diagnoses/conditions."
    },

    "final_allergy_id": {
      "type": "uuid",
      "examples": ["uuid-of-allergy-record"],
      "guidance": "UUID link to patient_allergies(id). Populate for allergies/sensitivities."
    },

    "final_vital_id": {
      "type": "uuid",
      "examples": ["uuid-of-vital-record"],
      "guidance": "UUID link to patient_vitals(id). Populate for vital signs (often WITH final_observation_id)."
    }
  },

  "fields_not_modified_by_pass2": [
    "shell_file_id",
    "patient_id",
    "processing_session_id",
    "entity_id",
    "original_text",
    "entity_category",
    "entity_subtype",
    "unique_marker",
    "location_context",
    "spatial_bbox",
    "page_number",
    "pass1_confidence",
    "requires_schemas",
    "processing_priority",
    "pass1_model_used",
    "pass1_vision_processing",
    "pass1_token_usage",
    "pass1_image_tokens",
    "pass1_cost_estimate",
    "ai_visual_interpretation",
    "visual_formatting_context",
    "ai_visual_confidence",
    "ocr_reference_text",
    "ocr_confidence",
    "ocr_provider",
    "ai_ocr_agreement_score",
    "spatial_mapping_source",
    "discrepancy_type",
    "discrepancy_notes",
    "visual_quality_assessment",
    "validation_flags",
    "cross_validation_score",
    "manual_review_required",
    "profile_verification_confidence",
    "pii_sensitivity_level",
    "compliance_flags",
    "manual_review_completed",
    "manual_review_notes",
    "manual_reviewer_id"
  ],

  "examples": [
    {
      "description": "Successful vital sign enrichment (dual link to observations + vitals)",
      "update": {
        "pass2_status": "completed",
        "pass2_confidence": 0.920,
        "pass2_started_at": "2025-01-01T12:35:10Z",
        "pass2_completed_at": "2025-01-01T12:35:18Z",
        "pass2_model_used": "gpt-4o-mini",
        "pass2_token_usage": 2400,
        "pass2_cost_estimate": 0.0062,
        "final_observation_id": "uuid-of-observation-record",
        "final_vital_id": "uuid-of-vital-record"
      }
    },
    {
      "description": "Failed enrichment (insufficient data)",
      "update": {
        "pass2_status": "failed",
        "pass2_started_at": "2025-01-15T09:32:10Z",
        "pass2_completed_at": "2025-01-15T09:32:15Z",
        "enrichment_errors": "Insufficient context for clinical classification - missing date information",
        "pass2_model_used": "gpt-4o-mini",
        "pass2_token_usage": 1200,
        "pass2_cost_estimate": 0.0031
      }
    },
    {
      "description": "Medication enrichment",
      "update": {
        "pass2_status": "completed",
        "pass2_confidence": 0.850,
        "pass2_started_at": "2025-01-20T14:10:05Z",
        "pass2_completed_at": "2025-01-20T14:10:12Z",
        "pass2_model_used": "gpt-4o-mini",
        "pass2_token_usage": 3200,
        "pass2_cost_estimate": 0.0082,
        "final_intervention_id": "uuid-of-intervention-record"
      }
    },
    {
      "description": "Diagnosis enrichment (dual link to conditions + events)",
      "update": {
        "pass2_status": "completed",
        "pass2_confidence": 0.880,
        "pass2_started_at": "2025-02-03T10:15:22Z",
        "pass2_completed_at": "2025-02-03T10:15:30Z",
        "pass2_model_used": "gpt-4o-mini",
        "pass2_token_usage": 2800,
        "pass2_cost_estimate": 0.0072,
        "final_condition_id": "uuid-of-condition-record",
        "final_event_id": "uuid-of-clinical-event-record"
      }
    },
    {
      "description": "In-progress status",
      "update": {
        "pass2_status": "in_progress",
        "pass2_started_at": "2025-01-01T12:35:10Z",
        "pass2_model_used": "gpt-4o-mini"
      }
    }
  ],

  "update_guidelines": {
    "operation": "UPDATE existing entity audit record (Pass 1 created it)",
    "idempotency": "Use WHERE pass2_status = 'pending' guard for safety",
    "readonly_pass1": "Do NOT modify ANY Pass 1 fields (entity identity, spatial data, Pass 1 metrics)",
    "status_progression": "'pending' → ['in_progress'] → 'completed' | 'failed'",
    "timestamp_pattern": "Use COALESCE(pass2_started_at, NOW()) to set once",
    "clinical_links": "Populate ONE OR MORE final_*_id based on entity_subtype",
    "multiple_links": "Some entities link to multiple tables (vital signs → observations + vitals)",
    "cost_tracking": "Pass 2 costs are separate from Pass 1 (both tracked independently)",
    "error_handling": "If enrichment fails, populate enrichment_errors with diagnostic message"
  },

  "clinical_link_mapping": {
    "vital_sign_blood_pressure": ["final_observation_id", "final_vital_id"],
    "vital_sign_heart_rate": ["final_observation_id", "final_vital_id"],
    "vital_sign_temperature": ["final_observation_id", "final_vital_id"],
    "vital_sign_respiratory_rate": ["final_observation_id", "final_vital_id"],
    "vital_sign_oxygen_saturation": ["final_observation_id", "final_vital_id"],
    "vital_sign_height": ["final_observation_id", "final_vital_id"],
    "vital_sign_weight": ["final_observation_id", "final_vital_id"],
    "medication": ["final_intervention_id"],
    "diagnosis": ["final_condition_id", "final_event_id"],
    "condition": ["final_condition_id"],
    "allergy": ["final_allergy_id"],
    "lab_result": ["final_observation_id"],
    "procedure": ["final_intervention_id", "final_event_id"],
    "appointment": ["final_encounter_id"],
    "clinical_note": ["final_event_id"],
    "immunization": ["final_intervention_id"]
  },

  "validation_rules": {
    "pass2_status": "Must be 'in_progress', 'completed', or 'failed' (not 'pending' or 'skipped')",
    "pass2_started_at": "Must be valid TIMESTAMPTZ (set once)",
    "pass2_completed_at": "Must be valid TIMESTAMPTZ (>= pass2_started_at if both set)",
    "pass2_confidence": "If provided, must be 0.000-1.000",
    "enrichment_errors": "Should be populated if pass2_status='failed'",
    "final_links": "At least ONE final_*_id should be populated for successful enrichment (application rule, not DB-enforced)",
    "final_link_uuids": "All final_*_id values must be valid UUIDs",
    "document_structure_constraint": "entity_category='document_structure' must have ALL final_*_id as NULL (DB-enforced)",
    "pass1_fields_readonly": "All Pass 1 fields must NOT be modified",
    "where_guard": "UPDATE should include WHERE pass2_status = 'pending' guard"
  }
}
